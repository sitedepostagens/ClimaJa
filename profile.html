<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --primary: #2563eb;
      --accent: #38bdf8;
      --muted: #64748b;
      --card-bg: #ffffff;
      --glass: rgba(255,255,255,0.7);
    }
    /* Base */
    body{
      background: linear-gradient(180deg,#f0f9ff 0%, #eef2ff 50%, #f8fafc 100%);
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      color: #0f172a;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    /* Card principal */
    .profile-card{
      max-width:980px;
      margin:2.5rem auto;
      background: linear-gradient(180deg, rgba(255,255,255,0.96), rgba(248,250,255,0.96));
      border-radius:1.25rem;
      padding:1.25rem;
      box-shadow: 0 12px 36px rgba(37,99,235,0.08);
      border: 1px solid rgba(37,99,235,0.06);
      overflow: hidden;
    }

    /* header decorativo do card */
    .profile-card::before{
      content: '';
      display:block;
      height:6px;
      width:100%;
      background: linear-gradient(90deg,var(--accent), var(--primary));
      margin-bottom: 12px;
      border-radius: 6px;
      opacity: 0.96;
    }

    .profile-hero{display:flex;gap:1rem;align-items:flex-start;min-width:0}
    .hero-left{display:flex;gap:1rem;align-items:center;min-width:0}

    .avatar-wrap{position:relative;flex:0 0 auto}
    .avatar-lg{width:104px;height:104px;border-radius:50%;object-fit:cover;border:4px solid #fff;box-shadow:0 8px 30px rgba(37,99,235,0.12)}
    .avatar-ring{position:absolute;left:-6px;top:-6px;width:116px;height:116px;border-radius:50%;border:2px dashed rgba(56,189,248,0.15);pointer-events:none}
    .verified-badge{position:absolute;right:-8px;bottom:-8px;background:#fff;padding:6px;border-radius:50%;color:var(--primary);font-size:0.95rem;box-shadow:0 6px 18px rgba(2,6,23,0.06)}

    .profile-meta h2{margin:0;font-size:1.35rem;color:var(--primary);font-weight:800}
    .profile-meta .profile-role{color:var(--muted);margin-top:6px}

    .profile-email{color:#0f172a;font-weight:600;overflow-wrap:anywhere;word-break:break-word;max-width:420px;background:linear-gradient(90deg,transparent, rgba(37,99,235,0.02));padding:6px 10px;border-radius:8px}

    /* Ações e stats (direita) */
    .hero-right{margin-left:auto;display:flex;flex-direction:column;align-items:flex-end;gap:12px}
    .profile-actions{display:flex;gap:0.6rem;align-items:center}
    .profile-actions .btn{border-radius:0.6rem;padding:0.5rem 0.9rem;font-weight:600}
    .btn-edit{background:linear-gradient(90deg,var(--primary), var(--accent));border:none;color:#fff}
    .btn-edit:hover{transform:translateY(-2px);box-shadow:0 8px 30px rgba(37,99,235,0.12)}

    .profile-stats{display:flex;gap:0.8rem;align-items:center}
    .profile-stats .stat{background:linear-gradient(180deg,#fff,#fbfdff);padding:0.65rem 0.9rem;border-radius:0.7rem;min-width:92px;box-shadow:0 6px 18px rgba(37,99,235,0.04);text-align:center}
    .profile-stats .stat .small{color:var(--muted);font-size:0.78rem}
    .profile-stats .count{font-size:1.2rem;color:#0f172a;font-weight:800}

    .section{margin-top:1.2rem;padding-top:0.8rem;border-top:1px solid rgba(37,99,235,0.04)}

    /* modal-like custom styles */
    .custom-modal{display:none;position:fixed;inset:0;background:rgba(2,6,23,0.45);align-items:center;justify-content:center;z-index:1200}
    .custom-modal .modal-dialog{max-width:820px;width:92%;}
    .custom-modal .modal-content{border-radius:.75rem;background:#fff;padding:0}

    /* Responsivo */
    @media (max-width:880px){
      .profile-hero{flex-direction:column;align-items:stretch}
      .hero-right{margin-left:0;align-items:flex-start;flex-direction:row;justify-content:space-between}
      .avatar-lg{width:92px;height:92px}
      .profile-email{max-width:100%}
      .profile-actions{align-items:flex-start}
    }
    @media (max-width:420px){
      .avatar-lg{width:80px;height:80px}
      .profile-meta h2{font-size:1.05rem}
      .profile-stats{flex-wrap:wrap;gap:0.5rem}
    }
  </style>

  </head>
  <body>

  <!-- Card de Perfil (inserido para restaurar a área do perfil em branco) -->
  <div class="profile-card container">
    <div class="profile-hero">
      <div class="hero-left">
        <div class="avatar-wrap">
          <div class="avatar-ring" aria-hidden="true"></div>
          <img id="profile-avatar" class="avatar-lg" src="logo.png" alt="Avatar do usuário">
          <div id="verified-badge" class="verified-badge" style="display:none"><i class="fas fa-check"></i></div>
        </div>
        <div class="profile-meta">
          <h2 id="profile-name">Usuário ClimaJá</h2>
          <div class="small profile-role">Membro</div>
          <div id="profile-email" class="profile-email">usuario@example.com</div>
        </div>
      </div>

      <div class="hero-right">
        <div class="profile-stats">
          <div class="stat"><div class="count" id="profile-relatos-count">0</div><div class="small">Relatos</div></div>
          <div class="stat"><div class="count" id="profile-upvotes">0</div><div class="small">Upvotes</div></div>
        </div>
        <div class="profile-actions">
          <button id="profile-edit-btn" class="btn btn-edit"><i class="fas fa-edit me-1"></i>Editar</button>
          <a id="profile-back-home" class="btn btn-outline-secondary" href="index.html">Voltar</a>
        </div>
      </div>
    </div>

    <div class="section">
      <h5>Sobre</h5>
      <p id="profile-bio">Nenhuma informação adicional disponível.</p>
    </div>

    <div class="section">
      <h5>Relatos</h5>
      <div id="relatos-list">Nenhum relato publicado ainda.</div>
    </div>
  </div>

  <!-- Modal de edição (custom para evitar depender do JS do Bootstrap) -->
  <!-- Observação: removi a classe `d-flex` do markup inicial para evitar que o modal
    fique visível por padrão; o script agora controla visibilidade via classe + style. -->
  <div id="profile-edit-modal" class="custom-modal">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header d-flex align-items-center">
          <h5 class="modal-title">Editar Perfil</h5>
          <button type="button" class="btn-close modal-close ms-auto" aria-label="Fechar"></button>
        </div>
        <form id="profile-edit-form" class="modal-body p-3">
          <div class="row g-3">
            <div class="col-md-5">
              <label class="form-label">Avatar</label>
              <div id="avatar-dropzone" class="p-3 text-center">
                <img id="edit-avatar-preview" src="logo.png" alt="Preview">
                <div>
                  <input type="file" id="edit-avatar" accept="image/*" class="form-control d-none" aria-label="Escolher avatar">
                  <button type="button" id="choose-avatar-btn" class="btn btn-outline-primary btn-sm">Escolher imagem</button>
                  <button type="button" id="remove-avatar-btn" class="btn btn-outline-secondary btn-sm ms-2">Remover</button>
                </div>
                <small class="text-muted">Arraste e solte ou escolha uma imagem (PNG/JPG). Em produção, salve no Storage.</small>
              </div>
            </div>
            <div class="col-md-7">
              <div class="mb-2">
                <label class="form-label">Nome público</label>
                <input type="text" id="edit-displayName" class="form-control" placeholder="Seu nome público" aria-label="Nome público">
              </div>
              <div class="mb-2">
                <label class="form-label">Bio</label>
                <textarea id="edit-bio" class="form-control" rows="4" placeholder="Fale um pouco sobre você" aria-label="Biografia"></textarea>
              </div>
              <div class="d-flex align-items-center mt-2">
                <div id="profile-save-spinner" class="spinner-border text-primary me-2 d-none" role="status" aria-hidden="true"></div>
                <div id="profile-save-msg" class="text-success small d-none">Salvo com sucesso!</div>
              </div>
            </div>
          </div>

          <div class="d-flex justify-content-end gap-2 mt-3">
            <button type="button" class="btn btn-secondary modal-close">Cancelar</button>
            <button type="submit" class="btn btn-primary" id="profile-save-btn">Salvar alterações</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  
  <!-- Modal de Segurança e Acesso -->
  <div id="security-modal" class="custom-modal">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header d-flex align-items-center">
          <h5 class="modal-title"><i class="fas fa-lock me-2"></i>Segurança e Acesso</h5>
          <button type="button" class="btn-close security-close ms-auto" aria-label="Fechar"></button>
        </div>
        <div class="modal-body p-3">
          <p class="small text-muted">Aqui você pode gerenciar opções básicas de segurança. Em produção, ações sensíveis (troca de senha, revogar sessões) são realizadas via Firebase Auth ou backend seguro.</p>
          <div class="mb-3">
            <label class="form-label">Email de conta</label>
            <div id="security-email" class="form-control-plaintext">usuario@example.com</div>
          </div>
          <div class="mb-3">
            <label class="form-label">Redefinir senha</label>
            <div class="d-flex gap-2">
              <button id="send-reset-btn" class="btn btn-outline-primary">Enviar link de redefinição</button>
              <button id="local-reset-btn" class="btn btn-outline-secondary">Modo demo: marcar como redefinida</button>
            </div>
            <small class="form-text text-muted">Será enviado um e-mail com instruções (se o serviço de autenticação estiver ativo).</small>
          </div>
          <div class="mb-3">
            <label class="form-label">Sessões ativas</label>
            <div id="sessions-list" class="small text-muted">Nenhuma informação disponível localmente.</div>
            <div class="mt-2"><button id="revoke-sessions-btn" class="btn btn-sm btn-danger">Revogar todas as sessões</button></div>
          </div>
          <div class="mb-0">
            <label class="form-label">Autenticação em 2 fatores</label>
            <div class="form-check form-switch mt-2">
              <input class="form-check-input" type="checkbox" id="toggle-2fa">
              <label class="form-check-label small" for="toggle-2fa">Ativar verificação em duas etapas (placeholder)</label>
            </div>
            <small class="text-muted">Ativação de 2FA deve ser implementada com provedores externos (Authenticator / SMS) em produção.</small>
          </div>
        </div>
        <div class="modal-footer p-3">
          <button type="button" class="btn btn-secondary security-close">Fechar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script>
    (function () {
      // Elementos usados por várias funções — guardamos referências para evitar buscas repetidas
      const modal = document.getElementById('profile-edit-modal');
      const modalCloseBtns = Array.from(document.querySelectorAll('.modal-close'));
      const editBtn = document.getElementById('profile-edit-btn') || document.getElementById('perfil-editar') || null;
      const form = document.getElementById('profile-edit-form');
      const nameEl = document.getElementById('profile-name') || document.getElementById('perfil-nome') || null;
      const emailEl = document.getElementById('profile-email') || null;
      const relatosCountEl = document.getElementById('profile-relatos-count') || document.getElementById('relatos-count') || null;
      const upvotesEl = document.getElementById('profile-upvotes') || null;
      const sinceEl = document.getElementById('profile-member-since') || null;
      const bioEl = document.getElementById('profile-bio') || null;
      const avatarEl = document.getElementById('profile-avatar') || document.getElementById('avatar') || document.getElementById('edit-avatar-preview') || null;
      const relatosListEl = document.getElementById('relatos-list') || null;

      const nameInput = document.getElementById('edit-displayName');
      const bioInput = document.getElementById('edit-bio');
      const avatarPreview = document.getElementById('edit-avatar-preview');
      const fileInput = document.getElementById('edit-avatar');

      function showModal() {
        if (!modal) return;
        // adiciona classe para layout e força display via style com priority important
        modal.classList.add('d-flex');
        modal.style.setProperty('display', 'flex', 'important');
        // acessibilidade
        modal.setAttribute('aria-hidden', 'false');
      }

      function hideModal() {
        if (!modal) return;
        console.debug('profile modal: hideModal() called');
        // remove classe e força display:none com priority important para vencer !important externos
        modal.classList.remove('d-flex');
        modal.style.setProperty('display', 'none', 'important');
        modal.setAttribute('aria-hidden', 'true');
      }

      // Fallback user storage (localStorage) structure:
      // localStorage.setItem('user', JSON.stringify({ displayName, email, photoURL, bio, uid, metadata }))
      function getLocalUser() {
        try { return JSON.parse(localStorage.getItem('user') || 'null'); } catch (e) { return null; }
      }
      function saveLocalUser(obj) {
        const cur = getLocalUser() || {};
        const merged = Object.assign({}, cur, obj);
        localStorage.setItem('user', JSON.stringify(merged));
      }

      // Preenche UI com dados do user (Firebase user-like object or local fallback)
      function fillUser(user) {
        if (!user) {
          nameEl.textContent = '- Usuário ClimaJá -';
          emailEl.textContent = 'usuario@exemplo.com';
          relatosCountEl.textContent = '0';
          upvotesEl.textContent = '0';
          sinceEl.textContent = '--';
          bioEl.textContent = 'Nenhuma informação adicional disponível.';
          avatarEl.src = 'logo.png';
          relatosListEl.innerHTML = 'Nenhum relato publicado ainda.';
          return;
        }

        nameEl.textContent = user.displayName || user.email || 'Usuário';
        emailEl.textContent = user.email || '-';
        relatosCountEl.textContent = (user.relatosCount !== undefined) ? String(user.relatosCount) : '—';
        upvotesEl.textContent = (user.upvotes !== undefined) ? String(user.upvotes) : '—';

        // creationTime pode ser string (Firebase) ou metadata.creationTime
        let created = '--';
        if (user.metadata && user.metadata.creationTime) {
          try { created = new Date(user.metadata.creationTime).toLocaleDateString(); } catch (e) { created = user.metadata.creationTime; }
        } else if (user.creationTime) {
          try { created = new Date(user.creationTime).toLocaleDateString(); } catch (e) { created = user.creationTime; }
        }
        sinceEl.textContent = created;
        bioEl.textContent = user.bio || 'Nenhuma informação adicional disponível.';
        avatarEl.src = user.photoURL || 'logo.png';

        // Preenche formulário de edição com dados existentes (fallback)
        if (nameInput) nameInput.value = user.displayName || '';
        if (bioInput) bioInput.value = user.bio || '';
        if (avatarPreview) avatarPreview.src = user.photoURL || 'logo.png';
      }

      // Carregar relatos do Firestore (opcional) — só se Firestore estiver inicializado
      async function loadRelatos(uid) {
        relatosListEl.innerHTML = 'Carregando relatos...';
        try {
          if (!window.firebaseApp && !window.firebase) {
            relatosListEl.innerHTML = 'Relatos indisponíveis (Firebase não inicializado).';
            return;
          }
          // Tenta importar dinamicamente o módulo Firestore
          const firestoreModule = await import('https://www.gstatic.com/firebasejs/10.12.1/firebase-firestore.js');
          const { getFirestore, collection, query, where, orderBy, limit, getDocs } = firestoreModule;
          const db = getFirestore();
          const q = query(collection(db, 'relatos'), where('uid', '==', uid), orderBy('dataHora', 'desc'), limit(50));
          const snap = await getDocs(q);

          if (!snap || snap.empty) {
            relatosListEl.innerHTML = 'Nenhum relato publicado ainda.';
            relatosCountEl.textContent = '0';
            return;
          }
          const items = [];
          snap.forEach(doc => {
            const d = doc.data();
            const when = d.dataHora ? new Date(d.dataHora).toLocaleString() : '—';
            items.push(`<div class="card mb-2"><div class="card-body p-2"><div class="d-flex justify-content-between"><div><strong>${escapeHtml(d.ocorridoPrimario || 'Relato')}</strong><div class="small text-muted">${escapeHtml(d.address || 'Local não informado')}</div></div><div class="text-muted small">${when}</div></div></div></div>`);
          });
          relatosListEl.innerHTML = items.join('');
          relatosCountEl.textContent = String(snap.size || items.length);
        } catch (e) {
          console.warn('Não foi possível carregar relatos (Firestore):', e);
          relatosListEl.innerHTML = 'Relatos indisponíveis.';
        }
      }

      // Segurança simples para texto inserido em templates
      function escapeHtml(str) {
        if (!str) return '';
        return String(str)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;');
      }

      // Inicialização: observa estado do Auth se disponível, senão fallback localStorage
      async function initAuthObserver() {
        try {
          const authModule = await import('https://www.gstatic.com/firebasejs/10.12.1/firebase-auth.js');
          const { onAuthStateChanged } = authModule;
          const auth = window.auth || null;

          if (auth && typeof onAuthStateChanged === 'function') {
            onAuthStateChanged(auth, async (user) => {
              if (!user) {
                // fallback local user
                const demo = getLocalUser();
                fillUser(demo);
              } else {
                // Converte user Firebase para objeto leve (pegue metadata se disponível)
                const lightweight = {
                  displayName: user.displayName,
                  email: user.email,
                  photoURL: user.photoURL,
                  uid: user.uid,
                  metadata: user.metadata || {},
                };
                // Se quiser carregar relatos do Firestore:
                if (user.uid) loadRelatos(user.uid);
                fillUser(lightweight);
              }
            });
            return;
          }
        } catch (e) {
          console.warn('Erro ao inicializar auth (import):', e);
        }

        // Fallback: tenta carregar do localStorage
        const demo = getLocalUser();
        fillUser(demo);
      }

      // Event handlers
      editBtn && editBtn.addEventListener('click', function (e) {
        e.preventDefault();
        // Preenche o modal com os dados atuais (já preenchidos via fillUser)
        showModal();
      });

      // Fechar modal ao clicar nos botões com a classe `modal-close`
      modalCloseBtns.forEach(btn => btn.addEventListener('click', function (ev) {
        ev.preventDefault();
        console.debug('profile modal: modal-close clicked', btn);
        hideModal();
      }));

      // Fechar modal ao clicar no overlay (clicar fora da caixa de diálogo)
      if (modal) {
        modal.addEventListener('click', function (ev) {
          // Se o alvo do clique for o próprio overlay, fecha o modal
          if (ev.target === modal) {
            console.debug('profile modal: overlay clicked');
            hideModal();
          }
        });
      }

      // Fecha ao pressionar Esc — somente quando o modal estiver visível
      document.addEventListener('keydown', function (ev) {
        if (ev.key === 'Escape' || ev.key === 'Esc') {
          try {
            if (modal && modal.style && (modal.style.getPropertyValue('display') === 'flex' || modal.classList.contains('d-flex'))) {
              console.debug('profile modal: Escape pressed — closing modal');
              hideModal();
            }
          } catch (e) { /* silencioso */ }
        }
      });

      // Caso exista um botão de logout (id=profile-logout), conecta o fluxo de signOut.
      logoutBtn && logoutBtn.addEventListener('click', async function (e) {
        e.preventDefault();
        try {
          if (window.auth && window.signOut) {
            await window.signOut(window.auth);
            location.href = '/';
          } else {
            localStorage.removeItem('user');
            alert('Desconectado (modo demo).');
            location.href = '/';
          }
        } catch (err) {
          console.error('Erro ao sair:', err);
          alert('Erro ao sair: ' + (err && err.message ? err.message : err));
        }
      });

      // Botão Voltar (apenas navegação para index, sem logout)
      backHomeBtn && backHomeBtn.addEventListener('click', function (e) {
        // permite comportamento padrão se usuário abrir em nova aba; prevenimos apenas para navegação simples
        e.preventDefault();
        try {
          window.location.href = 'index.html';
        } catch (err) {
          window.location.href = '/';
        }
      });

      // Preview do avatar ao selecionar arquivo + drag & drop
      (function() {
        const dropzone = document.getElementById('avatar-dropzone');
        const chooseBtn = document.getElementById('choose-avatar-btn');
        const removeBtn = document.getElementById('remove-avatar-btn');
        const spinner = document.getElementById('profile-save-spinner');
        const saveMsg = document.getElementById('profile-save-msg');

        function readFileAsDataURL(file) {
          return new Promise((res, rej) => {
            const r = new FileReader();
            r.onload = () => res(r.result);
            r.onerror = () => rej(new Error('Falha ao ler arquivo'));
            r.readAsDataURL(file);
          });
        }

        // Choose button opens native file picker
        chooseBtn && chooseBtn.addEventListener('click', function() {
          fileInput && fileInput.click();
        });

        // Remove avatar -> reset to default
        removeBtn && removeBtn.addEventListener('click', function() {
          if (confirm('Remover avatar atual?')) {
            avatarPreview.src = 'logo.png';
            // Clear file input
            if (fileInput) { fileInput.value = ''; }
          }
        });

        // File input change
        if (fileInput && avatarPreview) {
          fileInput.addEventListener('change', async function () {
            const f = fileInput.files && fileInput.files[0];
            if (!f) {
              avatarPreview.src = avatarEl.src || 'logo.png';
              return;
            }
            try {
              const data = await readFileAsDataURL(f);
              avatarPreview.src = data;
            } catch (e) {
              console.warn('Erro ao ler imagem:', e);
            }
          });
        }

        // Drag & drop support
        if (dropzone) {
          dropzone.addEventListener('dragover', function(e) { e.preventDefault(); dropzone.style.borderColor = '#60a5fa'; });
          dropzone.addEventListener('dragleave', function(e) { dropzone.style.borderColor = '#cbd5e1'; });
          dropzone.addEventListener('drop', async function(e) {
            e.preventDefault(); dropzone.style.borderColor = '#cbd5e1';
            const f = e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0];
            if (!f) return;
            if (!f.type.startsWith('image/')) { alert('Por favor, selecione uma imagem.'); return; }
            try {
              const data = await readFileAsDataURL(f);
              avatarPreview.src = data;
              // populate fileInput (not all browsers allow setting FileList programmatically) -- we keep UI in sync
              if (fileInput) { fileInput.files = e.dataTransfer.files; }
            } catch (err) { console.warn('Erro ao processar imagem:', err); }
          });
        }

        // Helpers para spinner / mensagem
        function showSpinner() { spinner && spinner.classList.remove('d-none'); saveMsg && saveMsg.classList.add('d-none'); }
        function hideSpinner() { spinner && spinner.classList.add('d-none'); }
        function showSavedMsg() { saveMsg && (saveMsg.classList.remove('d-none')); }

        // Submissão do formulário de edição (com spinner, feedback e dispatch de evento)
        if (form) {
          form.addEventListener('submit', async function (ev) {
            ev.preventDefault();
            const saveBtn = document.getElementById('profile-save-btn');
            const newName = nameInput ? nameInput.value.trim() : '';
            const newBio = bioInput ? bioInput.value.trim() : '';
            let photoDataURL = null;

            try {
              // Ler imagem se existir
              if (fileInput && fileInput.files && fileInput.files[0]) {
                photoDataURL = await readFileAsDataURL(fileInput.files[0]);
              }

              // UI: spinner + disable
              showSpinner();
              if (saveBtn) saveBtn.disabled = true;

              let updatedUser = null;

              // Tenta atualizar via Firebase Auth se disponível
              if (window.auth && window.auth.currentUser) {
                try {
                  const authModule2 = await import('https://www.gstatic.com/firebasejs/10.12.1/firebase-auth.js');
                  const { updateProfile } = authModule2;
                  const user = window.auth.currentUser;
                  const updates = {};
                  if (newName) updates.displayName = newName;
                  if (photoDataURL) updates.photoURL = photoDataURL; // em produção, suba a Storage
                  await updateProfile(user, updates);
                  updatedUser = Object.assign({}, user, updates);
                  // Atualiza UI local
                  fillUser({
                    displayName: updatedUser.displayName || newName,
                    email: user.email,
                    photoURL: updatedUser.photoURL || avatarEl.src,
                    bio: newBio || '',
                    uid: user.uid,
                    metadata: user.metadata || {}
                  });
                } catch (errUpdate) {
                  console.warn('Falha ao atualizar via Firebase:', errUpdate);
                }
              }

              // Se não atualizou via Firebase, salva localmente
              let finalUserObj = null;
              if (!updatedUser) {
                const local = getLocalUser() || {};
                const demoUpdate = {
                  displayName: newName || local.displayName || nameEl.textContent,
                  photoURL: photoDataURL || local.photoURL || avatarEl.src,
                  bio: newBio || local.bio || bioEl.textContent,
                  email: local.email || emailEl.textContent,
                  metadata: local.metadata || { creationTime: new Date().toISOString() }
                };
                saveLocalUser(demoUpdate);
                fillUser(demoUpdate);
                finalUserObj = demoUpdate;
              } else {
                // atualizar também localStorage para consistência
                const up = {
                  displayName: updatedUser.displayName || newName,
                  photoURL: updatedUser.photoURL || avatarEl.src,
                  bio: newBio || '',
                  email: updatedUser.email || (getLocalUser() && getLocalUser().email) || emailEl.textContent,
                  metadata: updatedUser.metadata || {}
                };
                saveLocalUser(up);
                finalUserObj = up;
              }

              // Dispatch global event para atualizar header/UI
              try {
                document.dispatchEvent(new CustomEvent('auth-changed', { detail: finalUserObj }));
              } catch (ee) { console.debug('Não foi possível dispatch auth-changed:', ee); }

              // Feedback
              hideSpinner();
              showSavedMsg();
              setTimeout(() => { hideModal(); saveBtn && (saveBtn.disabled = false); saveMsg && saveMsg.classList.add('d-none'); }, 900);
            } catch (err) {
              console.error('Erro ao atualizar perfil:', err);
              hideSpinner();
              if (saveBtn) saveBtn.disabled = false;
              alert('Erro ao atualizar perfil: ' + (err && err.message ? err.message : err));
            }
          });
        }
      })();

      // Ao carregar a página: inicializa observador de autenticação/fallback
      document.addEventListener('DOMContentLoaded', function () {
        initAuthObserver();
      });

      // Small UI animations: animate counters and show verified badge
      function animateCounts() {
        document.querySelectorAll('.count').forEach(function(el) {
          const target = parseInt(el.getAttribute('data-target') || el.textContent || '0', 10) || 0;
          const start = 0;
          const duration = 900;
          let startTime = null;
          function step(ts) {
            if (!startTime) startTime = ts;
            const progress = Math.min((ts - startTime) / duration, 1);
            const value = Math.floor(progress * (target - start) + start);
            el.textContent = value;
            if (progress < 1) requestAnimationFrame(step);
            else el.textContent = String(target);
          }
          requestAnimationFrame(step);
        });
      }

      function markVerifiedIfNeeded(user) {
        try {
          const badge = document.getElementById('verified-badge');
          if (!badge) return;
          const isVerified = (user && (user.emailVerified || (user.email && user.email.endsWith('@example.com') && false))) || false;
          if (isVerified) badge.style.display = 'inline-flex';
          else badge.style.display = 'none';
        } catch (e) { /* silent */ }
      }

      // Trigger animations after fillUser is called — wrap existing fillUser
      const origFillUser = window.fillUser || null;
      // If fillUser exists in this scope, it's the inner function; we will call animateCounts after initAuthObserver fires
      document.addEventListener('DOMContentLoaded', function () {
        // Small delay to allow data to render
        setTimeout(function() {
          // populate data-target attributes from content so counts animate to correct numbers
          document.querySelectorAll('#profile-relatos-count, #profile-upvotes').forEach(function(el){
            const v = parseInt(el.textContent || el.getAttribute('data-target') || '0', 10) || 0;
            el.setAttribute('data-target', String(v));
            el.textContent = '0';
          });
          animateCounts();
          // mark verified based on localStorage/user
          let local = null;
          try { local = JSON.parse(localStorage.getItem('user')||'null'); } catch(e){ local = null; }
          const candidate = (window.auth && window.auth.currentUser) || local;
          markVerifiedIfNeeded(candidate);
          // Entry animation: add class then activate
          try {
            const card = document.querySelector('.profile-card');
            if (card) {
              card.classList.add('card-enter');
              // force reflow then activate (ensures transition)
              requestAnimationFrame(() => requestAnimationFrame(() => card.classList.add('active')));
            }
          } catch (e) { console.warn('entry animation error', e); }
          // Configurações removidas do profile; rolagem por âncora não é mais necessária.
        }, 450);
      });

      // Handlers para modal de Segurança e Acesso
      document.addEventListener('DOMContentLoaded', function () {
        const secModal = document.getElementById('security-modal');
        const secClose = document.querySelectorAll('.security-close');
        const linkPrivacy = document.getElementById('link-privacy');
        const securityEmail = document.getElementById('security-email');
        const sendResetBtn = document.getElementById('send-reset-btn');
        const localResetBtn = document.getElementById('local-reset-btn');
        const revokeSessionsBtn = document.getElementById('revoke-sessions-btn');
        const sessionsList = document.getElementById('sessions-list');
        const toggle2fa = document.getElementById('toggle-2fa');

        function openSecModal() {
          if (!secModal) return;
          secModal.classList.add('d-flex');
          secModal.style.setProperty('display','flex','important');
          secModal.setAttribute('aria-hidden','false');
          // preencher email
          const local = (function(){ try { return JSON.parse(localStorage.getItem('user')||'null'); } catch(e){return null;} })();
          const candidate = (window.auth && window.auth.currentUser && window.auth.currentUser.email) || (local && local.email) || document.getElementById('profile-email') && document.getElementById('profile-email').textContent || '';
          if (securityEmail) securityEmail.textContent = candidate || '—';
          // placeholder sessions
          if (sessionsList) sessionsList.textContent = 'Nenhuma sessão detectada localmente.';
        }

        function closeSecModal() {
          if (!secModal) return;
          secModal.classList.remove('d-flex');
          secModal.style.setProperty('display','none','important');
          secModal.setAttribute('aria-hidden','true');
        }

        linkPrivacy && linkPrivacy.addEventListener('click', function(e){ e.preventDefault(); openSecModal(); });
        secClose && secClose.forEach(btn => btn.addEventListener('click', function(ev){ ev.preventDefault(); closeSecModal(); }));
        if (secModal) secModal.addEventListener('click', function(ev){ if (ev.target === secModal) closeSecModal(); });

        // Enviar email de redefinição de senha via Firebase Auth (se disponível)
        sendResetBtn && sendResetBtn.addEventListener('click', async function(e){
          e.preventDefault();
          const email = securityEmail ? securityEmail.textContent : null;
          if (!email) { alert('Email não disponível.'); return; }
          try {
            if (window.firebase && window.firebase.auth && window.firebase.auth().sendPasswordResetEmail) {
              // SDK namespace: firebase.auth().sendPasswordResetEmail
              await window.firebase.auth().sendPasswordResetEmail(email);
              alert('Email de redefinição enviado para ' + email);
            } else if (window.auth && window.firebase) {
              // tenta usar nova API modular se exposta
              try {
                const authMod = await import('https://www.gstatic.com/firebasejs/10.12.1/firebase-auth.js');
                const { sendPasswordResetEmail } = authMod;
                await sendPasswordResetEmail(window.auth, email);
                alert('Email de redefinição enviado para ' + email);
              } catch (modErr) {
                console.warn('Modular sendPasswordResetEmail falhou:', modErr);
                alert('Não foi possível enviar o email de redefinição: serviço não disponível.');
              }
            } else {
              // fallback: modo demo
              alert('Serviço de autenticação não disponível — em modo demo você pode redefinir a senha manualmente nas configurações do backend.');
            }
          } catch (err) {
            console.error('Erro ao enviar email de redefinição:', err);
            alert('Erro ao enviar email de redefinição: ' + (err && err.message ? err.message : err));
          }
        });

        // Fallback local — apenas marca no localStorage
        localResetBtn && localResetBtn.addEventListener('click', function(e){
          e.preventDefault();
          const email = securityEmail ? securityEmail.textContent : null;
          if (!email) { alert('Email não disponível.'); return; }
          const local = (function(){ try { return JSON.parse(localStorage.getItem('user')||'null'); } catch(e){return null;} })() || {};
          local.passwordResetRequested = new Date().toISOString();
          localStorage.setItem('user', JSON.stringify(local));
          alert('Modo demo: redefinição marcada localmente para ' + email);
        });

        revokeSessionsBtn && revokeSessionsBtn.addEventListener('click', function(e){
          e.preventDefault();
          if (!confirm('Revogar todas as sessões para esta conta? (apenas placeholder em modo demo)')) return;
          // Em produção, chamar endpoint administrativo para revogar tokens
          // Aqui fazemos fallback local
          try {
            const local = (function(){ try { return JSON.parse(localStorage.getItem('user')||'null'); } catch(e){return null;} })();
            if (local) { local.sessionsRevokedAt = new Date().toISOString(); localStorage.setItem('user', JSON.stringify(local)); }
            if (sessionsList) sessionsList.textContent = 'Sessões revogadas localmente.';
            alert('Sessões revogadas (modo demo).');
          } catch (ee) { console.warn('Erro ao revogar sessões localmente', ee); alert('Erro ao tentar revogar sessões.'); }
        });

        // Toggle 2FA placeholder — salva preferência local
        toggle2fa && toggle2fa.addEventListener('change', function(e){
          try {
            const local = (function(){ try { return JSON.parse(localStorage.getItem('user')||'null'); } catch(e){return null;} })() || {};
            local.twoFactorEnabled = !!toggle2fa.checked;
            localStorage.setItem('user', JSON.stringify(local));
            alert('Configuração 2FA atualizada (modo demo): ' + (toggle2fa.checked ? 'Ativado' : 'Desativado'));
          } catch (err) { console.warn('Erro ao salvar 2FA localmente', err); }
        });
      });

    })();
  </script>

  <!-- Optionally include Bootstrap JS (not required for modal here) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" defer></script>
</body>
</html>
