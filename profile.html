<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="description" content="Perfil do usuário - ClimaJá">
  <title>Perfil - ClimaJá</title>
  
  <!-- FontAwesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  
  <style>
    /*
      Design System: "ClimaJá App"
      Inspirado em aplicativos de clima modernos, com foco em clareza,
      espaçamento e uma paleta de cores limpa (azul e branco).
    */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');

    :root {
      --primary: #007AFF; /* Azul vibrante (Apple-like) */
      --primary-light: #e6f2ff;
      --bg-main: #f4f7fa; /* Fundo principal (cinza muito claro) */
      --bg-card: #ffffff;
      --text-primary: #1d2d3d;
      --text-secondary: #6c7a89;
      --border: #e5e9ed;
      --shadow: 0 4px 12px rgba(0, 122, 255, 0.1);
      --shadow-hover: 0 8px 20px rgba(0, 122, 255, 0.15);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: var(--bg-main);
      color: var(--text-primary);
      line-height: 1.6;
      padding: 20px;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
    }

    /* Card principal do perfil */
    .profile-card {
      background: var(--bg-card);
      border-radius: 16px;
      box-shadow: var(--shadow);
      padding: 30px;
      margin-bottom: 20px;
      border: 1px solid var(--border);
    }

    .profile-hero {
      display: flex;
      gap: 25px;
      align-items: flex-start;
      flex-wrap: wrap;
    }

    .hero-left {
      display: flex;
      gap: 20px;
      align-items: center;
      flex: 1;
      min-width: 300px;
    }

    /* Avatar */
    .avatar-wrap {
      position: relative;
      flex-shrink: 0;
    }

    .avatar-lg {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      object-fit: cover;
      border: 4px solid var(--bg-card);
      box-shadow: 0 0 0 3px var(--primary);
    }

    .verified-badge {
      position: absolute;
      bottom: 2px;
      right: 2px;
      background: var(--primary);
      color: white;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      border: 3px solid var(--bg-card);
    }

    /* Meta do perfil */
    .profile-meta h2 {
      font-size: 26px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 5px;
    }

    .profile-role {
      color: var(--text-secondary);
      font-size: 15px;
      margin-bottom: 8px;
    }

    .profile-email {
      color: var(--text-secondary);
      font-size: 15px;
    }

    /* Ações e estatísticas */
    .hero-right {
      display: flex;
      flex-direction: column;
      gap: 15px;
      align-items: flex-end;
    }

    .profile-stats {
      display: flex;
      gap: 15px;
    }

    .stat {
      text-align: center;
      background: var(--primary-light);
      padding: 12px 20px;
      border-radius: 12px;
      min-width: 110px;
    }

    .stat .count {
      font-size: 26px;
      font-weight: 700;
      color: var(--primary);
      display: block;
    }

    .stat .small {
      font-size: 13px;
      color: var(--primary);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .profile-actions {
      display: flex;
      gap: 10px;
    }

    /* Botões */
    .btn {
      padding: 12px 22px;
      border-radius: 10px;
      font-weight: 600;
      font-size: 15px;
      cursor: pointer;
      border: none;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s;
    }

    .btn-edit {
      background: var(--primary);
      color: white;
    }

    .btn-edit:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-hover);
    }

    .btn-outline {
      background: var(--bg-card);
      color: var(--primary);
      border: 2px solid var(--border);
    }

    .btn-outline:hover {
      border-color: var(--primary);
      color: var(--primary);
    }

    /* Seções */
    .section {
      margin-top: 30px;
      padding-top: 30px;
      border-top: 1px solid var(--border);
    }

    .section h5 {
      font-size: 20px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .section h5 i {
      color: var(--primary);
    }

    #profile-bio {
      color: var(--text-secondary);
      line-height: 1.7;
      font-size: 16px;
    }

    /* Relatos */
    #relatos-list {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    #relatos-list .card {
      background: var(--bg-card);
      border-radius: 12px;
      padding: 20px;
      border: 1px solid var(--border);
      transition: all 0.2s;
    }

    #relatos-list .card:hover {
      box-shadow: var(--shadow);
      transform: translateY(-2px);
      border-color: var(--primary);
    }

    .relato-header {
      display: flex;
      justify-content: space-between;
      gap: 15px;
    }

    .relato-title {
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 5px;
      font-size: 16px;
    }

    .relato-address {
      font-size: 14px;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .relato-date {
      font-size: 14px;
      color: var(--text-secondary);
      white-space: nowrap;
    }

    /* Modal */
    .custom-modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(8px);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .custom-modal.d-flex {
      display: flex;
    }

    .modal-dialog {
      max-width: 600px;
      width: 100%;
    }

    .modal-content {
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.2);
      overflow: hidden;
    }

    .modal-header {
      padding: 25px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-title {
      font-size: 22px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .btn-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: var(--text-secondary);
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .btn-close:hover {
      color: var(--text-primary);
    }

    .modal-body {
      padding: 25px;
    }

    .modal-footer {
      padding: 20px 25px;
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      background: var(--bg-main);
    }

    /* Formulários */
    .form-label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--text-primary);
      font-size: 15px;
    }

    .form-control {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid var(--border);
      border-radius: 10px;
      font-size: 15px;
      transition: border 0.2s, box-shadow 0.2s;
    }

    .form-control:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px var(--primary-light);
    }

    textarea.form-control {
      resize: vertical;
      min-height: 120px;
      font-family: inherit;
    }

    #avatar-dropzone {
      position: relative;
      border: 2px dashed var(--border);
      border-radius: 50%;
      background: var(--bg-main);
      transition: border-color 0.2s;
      width: 150px;
      height: 150px;
      margin: 0 auto;
      overflow: hidden;
      display: block;
      cursor: pointer;
    }
    #avatar-dropzone:hover {
      border-color: var(--primary);
    }

    #edit-avatar-preview {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
      margin: 0;
      border: 0;
      pointer-events: none;
      user-select: none;
    }

    .row {
      display: flex;
      gap: 25px;
      flex-wrap: wrap;
    }

    .col-md-5 {
      flex: 0 0 auto;
      width: 40%;
    }

    .col-md-7 {
      flex: 1;
    }

    .mb-3 {
      margin-bottom: 20px;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background: #0062cc;
    }

    .btn-secondary {
      background: var(--bg-card);
      color: var(--text-primary);
      border: 1px solid var(--border);
    }

    .btn-secondary:hover {
      background: #e9ecef;
    }

    .btn-outline-primary, .btn-outline-secondary {
      background: transparent;
      border: 1px solid var(--border);
    }

    .btn-sm {
      padding: 8px 14px;
      font-size: 14px;
    }

    .text-muted {
      color: var(--text-secondary);
      font-size: 14px;
    }

    .text-success {
      color: #28a745;
    }

    .small {
      font-size: 14px;
    }

    .d-none { display: none !important; }
    .d-flex { display: flex; }
    .align-items-center { align-items: center; }
    .gap-2 { gap: 10px; }
    .mt-2 { margin-top: 10px; }
    .ms-2 { margin-left: 10px; }
    .me-2 { margin-right: 10px; }

    .spinner-border {
      border: 2px solid var(--primary);
      border-right-color: transparent;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 0.6s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Responsivo */
    @media (max-width: 768px) {
      .profile-hero { flex-direction: column; }
      .hero-left { min-width: 100%; }
      .hero-right { width: 100%; align-items: flex-start; }
      .profile-stats { width: 100%; justify-content: space-between; }
      .col-md-5, .col-md-7 { width: 100%; }
      .profile-actions { width: 100%; flex-direction: column; }
      .btn { width: 100%; justify-content: center; }
    }

    @media (max-width: 480px) {
      body { padding: 15px; }
      .profile-card { padding: 20px; }
      .hero-left { flex-direction: column; text-align: center; }
      .profile-meta { text-align: center; width: 100%; }
      .stat { flex: 1; min-width: auto; }
    }
  </style>

</head>
<body>

  <!-- Card de Perfil -->
  <div class="profile-card container">
    <div class="profile-hero">
      <div class="hero-left">
        <div class="avatar-wrap">
          <img id="profile-avatar" class="avatar-lg" src="logo.png" alt="Avatar do usuário">
          <div id="verified-badge" class="verified-badge" style="display:none" title="Conta verificada">
            <i class="fas fa-check"></i>
          </div>
        </div>
        <div class="profile-meta">
          <h2 id="profile-name">Usuário ClimaJá</h2>
          <div class="profile-role small">Membro</div>
          <div id="profile-email" class="profile-email">usuario@example.com</div>
        </div>
      </div>

      <div class="hero-right">
        <div class="profile-stats">
          <div class="stat">
            <div class="count" id="profile-relatos-count">0</div>
            <div class="small"><i class="fas fa-cloud-showers-heavy"></i> Relatos</div>
          </div>
          <div class="stat">
            <div class="count" id="profile-upvotes">0</div>
            <div class="small"><i class="fas fa-thumbs-up"></i> Upvotes</div>
          </div>
        </div>
        <div class="profile-actions" role="group" aria-label="Ações do usuário">
          <button id="profile-edit-btn" class="btn btn-edit" aria-haspopup="dialog" aria-controls="profile-edit-modal">
            <i class="fas fa-edit" aria-hidden="true"></i>
            <span>Editar</span>
          </button>
          <a id="profile-back-home" class="btn btn-outline" href="index.html">
            <i class="fas fa-arrow-left" aria-hidden="true"></i>
            <span>Voltar</span>
          </a>
        </div>
      </div>
    </div>

    <div class="section">
      <h5><i class="fas fa-user-circle" aria-hidden="true"></i> Sobre</h5>
      <p id="profile-bio">Nenhuma informação adicional disponível.</p>
    </div>

    <div class="section">
      <h5><i class="fas fa-cloud-showers-heavy" aria-hidden="true"></i> Relatos</h5>
      <div id="relatos-list"><div class="text-muted p-3 text-center">Nenhum relato publicado ainda.</div></div>
    </div>
  </div>

  <!-- Modal de edição (custom para evitar depender do JS do Bootstrap) -->
  <!-- Observação: removi a classe `d-flex` do markup inicial para evitar que o modal
    fique visível por padrão; o script agora controla visibilidade via classe + style. -->
  <div id="profile-edit-modal" class="custom-modal" role="dialog" aria-modal="true" aria-labelledby="edit-modal-title" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 id="edit-modal-title" class="modal-title"><i class="fas fa-user-edit me-2" aria-hidden="true"></i>Editar Perfil</h5>
          <button type="button" class="btn-close modal-close" aria-label="Fechar">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <form id="profile-edit-form" class="modal-body">
          <div class="row g-3">
            <div class="col-md-5">
              <label class="form-label">Avatar</label>
              <div id="avatar-dropzone" class="text-center" role="button" tabindex="0" aria-label="Escolher avatar (arraste e solte ou clique)">
                <img id="edit-avatar-preview" src="logo.png" alt="" aria-label="Preview do avatar" loading="lazy" draggable="false">
              </div>
              <div class="mt-2 text-center">
                <input type="file" id="edit-avatar" accept="image/*" class="form-control d-none" aria-label="Escolher avatar">
                <button type="button" id="choose-avatar-btn" class="btn btn-outline-primary btn-sm">
                  <i class="fas fa-image"></i> Escolher
                </button>
                <button type="button" id="remove-avatar-btn" class="btn btn-outline-secondary btn-sm ms-2">
                  <i class="fas fa-trash-alt"></i> Remover
                </button>
                <div class="mt-1"><small class="text-muted form-text">Arraste e solte ou escolha uma imagem (PNG/JPG)</small></div>
              </div>
            </div>
            <div class="col-md-7">
              <div class="mb-3">
                <label class="form-label">Nome público</label>
                <input type="text" id="edit-displayName" class="form-control" placeholder="Seu nome público" aria-label="Nome público">
              </div>
              <div class="mb-3">
                <label class="form-label">Bio</label>
                <textarea id="edit-bio" class="form-control" rows="4" placeholder="Fale um pouco sobre você" aria-label="Biografia"></textarea>
              </div>
              <div class="d-flex align-items-center mt-2">
                <div id="profile-save-spinner" class="spinner-border text-primary me-2 d-none" role="status" aria-hidden="true"></div>
                <div id="profile-save-msg" class="text-success small d-none"><i class="fas fa-check-circle"></i> Salvo com sucesso!</div>
              </div>
            </div>
          </div>
        </form>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary modal-close">Cancelar</button>
          <button type="submit" form="profile-edit-form" class="btn btn-primary" id="profile-save-btn">
            <i class="fas fa-save"></i> Salvar alterações
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Modal de Segurança e Acesso -->
  <div id="security-modal" class="custom-modal" role="dialog" aria-modal="true" aria-labelledby="security-modal-title" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header d-flex align-items-center">
          <h5 id="security-modal-title" class="modal-title"><i class="fas fa-lock me-2" aria-hidden="true"></i>Segurança e Acesso</h5>
          <button type="button" class="btn-close security-close ms-auto" aria-label="Fechar"></button>
        </div>
        <div class="modal-body p-3">
          <p class="small text-muted">Aqui você pode gerenciar opções básicas de segurança. Em produção, ações sensíveis (troca de senha, revogar sessões) são realizadas via Firebase Auth ou backend seguro.</p>
          <div class="mb-3">
            <label class="form-label">Email de conta</label>
            <div id="security-email" class="form-control-plaintext">usuario@example.com</div>
          </div>
          <div class="mb-3">
            <label class="form-label">Redefinir senha</label>
            <div class="d-flex gap-2">
              <button id="send-reset-btn" class="btn btn-outline-primary">Enviar link de redefinição</button>
              <button id="local-reset-btn" class="btn btn-outline-secondary">Modo demo: marcar como redefinida</button>
            </div>
            <small class="form-text text-muted">Será enviado um e-mail com instruções (se o serviço de autenticação estiver ativo).</small>
          </div>
          <div class="mb-3">
            <label class="form-label">Sessões ativas</label>
            <div id="sessions-list" class="small text-muted">Nenhuma informação disponível localmente.</div>
            <div class="mt-2"><button id="revoke-sessions-btn" class="btn btn-sm btn-danger">Revogar todas as sessões</button></div>
          </div>
          <div class="mb-0">
            <label class="form-label">Autenticação em 2 fatores</label>
            <div class="form-check form-switch mt-2">
              <input class="form-check-input" type="checkbox" id="toggle-2fa">
              <label class="form-check-label small" for="toggle-2fa">Ativar verificação em duas etapas (placeholder)</label>
            </div>
            <small class="text-muted">Ativação de 2FA deve ser implementada com provedores externos (Authenticator / SMS) em produção.</small>
          </div>
        </div>
        <div class="modal-footer p-3">
          <button type="button" class="btn btn-secondary security-close">Fechar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script>
    (function () {
      // Elementos usados por várias funções — guardamos referências para evitar buscas repetidas
      const modal = document.getElementById('profile-edit-modal');
      const modalCloseBtns = Array.from(document.querySelectorAll('.modal-close'));
      const editBtn = document.getElementById('profile-edit-btn') || document.getElementById('perfil-editar') || null;
      const backHomeBtn = document.getElementById('profile-back-home') || null;
      const form = document.getElementById('profile-edit-form');
      const nameEl = document.getElementById('profile-name') || document.getElementById('perfil-nome') || null;
      const emailEl = document.getElementById('profile-email') || null;
      const relatosCountEl = document.getElementById('profile-relatos-count') || document.getElementById('relatos-count') || null;
      const upvotesEl = document.getElementById('profile-upvotes') || null;
      const sinceEl = document.getElementById('profile-member-since') || null;
      const bioEl = document.getElementById('profile-bio') || null;
      const avatarEl = document.getElementById('profile-avatar') || document.getElementById('avatar') || document.getElementById('edit-avatar-preview') || null;
      const relatosListEl = document.getElementById('relatos-list') || null;

      const nameInput = document.getElementById('edit-displayName');
      const bioInput = document.getElementById('edit-bio');
      const avatarPreview = document.getElementById('edit-avatar-preview');
      // Garante fallback silencioso caso a imagem falhe (evita texto alternativo visível)
      if (avatarPreview) {
        avatarPreview.addEventListener('error', function () {
          try {
            if (!/logo\.png(?:$|\?)/.test((avatarPreview.getAttribute('src')||''))) {
              avatarPreview.src = 'logo.png';
            }
          } catch (e) { /* noop */ }
        }, { once: false });
      }
      const fileInput = document.getElementById('edit-avatar');

      function showModal() {
        if (!modal) return;
        // adiciona classe para layout e força display via style com priority important
        modal.classList.add('d-flex');
        modal.style.setProperty('display', 'flex', 'important');
        // acessibilidade
        modal.setAttribute('aria-hidden', 'false');
      }

      function hideModal() {
        if (!modal) return;
        console.debug('profile modal: hideModal() called');
        // remove classe e força display:none com priority important para vencer !important externos
        modal.classList.remove('d-flex');
        modal.style.setProperty('display', 'none', 'important');
        modal.setAttribute('aria-hidden', 'true');
      }

      // Fallback user storage (localStorage) structure:
      // localStorage.setItem('user', JSON.stringify({ displayName, email, photoURL, bio, uid, metadata }))
      function getLocalUser() {
        try { return JSON.parse(localStorage.getItem('user') || 'null'); } catch (e) { return null; }
      }
      function saveLocalUser(obj) {
        const cur = getLocalUser() || {};
        const merged = Object.assign({}, cur, obj);
        localStorage.setItem('user', JSON.stringify(merged));
      }

      // Preenche UI com dados do user (Firebase user-like object or local fallback)
      function fillUser(user) {
        const defaultUser = {
          displayName: 'Usuário ClimaJá',
          email: 'usuario@example.com',
          relatosCount: 0,
          upvotes: 0,
          bio: 'Nenhuma informação adicional disponível.',
          photoURL: 'logo.png',
          metadata: {}
        };
        const userData = Object.assign({}, defaultUser, user);

        if (nameEl) nameEl.textContent = userData.displayName;
        if (emailEl) emailEl.textContent = userData.email;
        if (relatosCountEl) relatosCountEl.textContent = String(userData.relatosCount || '0');
        if (upvotesEl) upvotesEl.textContent = String(userData.upvotes || '0');
        if (bioEl) bioEl.textContent = userData.bio;
        if (avatarEl) avatarEl.src = userData.photoURL;

        // Preenche o formulário de edição com os dados atuais
        if (nameInput) nameInput.value = userData.displayName;
        if (bioInput) bioInput.value = userData.bio;
        if (avatarPreview) avatarPreview.src = userData.photoURL;
      }

      // Carregar relatos do Firestore (opcional) — só se Firestore estiver inicializado
      async function loadRelatos(uid) {
        relatosListEl.innerHTML = 'Carregando relatos...';
        try {
          if (!window.firebaseApp && !window.firebase) {
            relatosListEl.innerHTML = 'Relatos indisponíveis (Firebase não inicializado).';
            return;
          }
          // Tenta importar dinamicamente o módulo Firestore
          const firestoreModule = await import('https://www.gstatic.com/firebasejs/10.12.1/firebase-firestore.js');
          const { getFirestore, collection, query, where, orderBy, limit, getDocs } = firestoreModule;
          const db = getFirestore();
          const q = query(collection(db, 'relatos'), where('uid', '==', uid), orderBy('dataHora', 'desc'), limit(50));
          const snap = await getDocs(q);

          if (!snap || snap.empty) {
            relatosListEl.innerHTML = 'Nenhum relato publicado ainda.';
            relatosCountEl.textContent = '0';
            return;
          }
          const items = [];
          snap.forEach(doc => {
            const d = doc.data();
            const when = d.dataHora ? new Date(d.dataHora).toLocaleString('pt-BR', {day:'2-digit',month:'short',hour:'2-digit',minute:'2-digit'}) : '—';
            items.push(`<div class="card">
              <div class="card-body">
                <div class="relato-header">
                  <div>
                    <h6 class="relato-title">${escapeHtml(d.ocorridoPrimario || 'Relato')}</h6>
                    <div class="relato-address"><i class="fas fa-map-marker-alt" aria-hidden="true"></i> ${escapeHtml(d.address || 'Local não informado')}</div>
                  </div>
                  <div class="relato-date">${when}</div>
                </div>
              </div>
            </div>`);
          });
          relatosListEl.innerHTML = items.join('');
          relatosCountEl.textContent = String(snap.size || items.length);
        } catch (e) {
          console.warn('Não foi possível carregar relatos (Firestore):', e);
          relatosListEl.innerHTML = 'Relatos indisponíveis.';
        }
      }

      // Segurança simples para texto inserido em templates
      function escapeHtml(str) {
        if (!str) return '';
        return String(str)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;');
      }

      // Inicialização: observa estado do Auth se disponível, senão fallback localStorage
      async function initAuthObserver() {
        try {
          const authModule = await import('https://www.gstatic.com/firebasejs/10.12.1/firebase-auth.js');
          const { onAuthStateChanged } = authModule;
          const auth = window.auth || null;

          if (auth && typeof onAuthStateChanged === 'function') {
            onAuthStateChanged(auth, async (user) => {
              if (!user) {
                // fallback local user
                const demo = getLocalUser();
                fillUser(demo);
              } else {
                // Converte user Firebase para objeto leve (pegue metadata se disponível)
                const lightweight = {
                  displayName: user.displayName,
                  email: user.email,
                  photoURL: user.photoURL,
                  uid: user.uid,
                  metadata: user.metadata || {},
                };
                // Se quiser carregar relatos do Firestore:
                if (user.uid) loadRelatos(user.uid);
                fillUser(lightweight);
              }
            });
            return;
          }
        } catch (e) {
          console.warn('Erro ao inicializar auth (import):', e);
        }

        // Fallback: tenta carregar do localStorage
        const demo = getLocalUser();
        fillUser(demo);
      }

      // Event handlers
      editBtn && editBtn.addEventListener('click', function (e) {
        e.preventDefault();
        // Preenche o modal com os dados atuais (já preenchidos via fillUser)
        showModal();
      });

      // Fechar modal ao clicar nos botões com a classe `modal-close`
      modalCloseBtns.forEach(btn => btn.addEventListener('click', function (ev) {
        ev.preventDefault();
        console.debug('profile modal: modal-close clicked', btn);
        hideModal();
      }));

      // Fechar modal ao clicar no overlay (clicar fora da caixa de diálogo)
      if (modal) {
        modal.addEventListener('click', function (ev) {
          // Se o alvo do clique for o próprio overlay, fecha o modal
          if (ev.target === modal) {
            console.debug('profile modal: overlay clicked');
            hideModal();
          }
        });
      }

      // Botão Voltar (apenas navegação para index, sem logout)
      backHomeBtn && backHomeBtn.addEventListener('click', function (e) {
        // permite comportamento padrão se usuário abrir em nova aba; prevenimos apenas para navegação simples
        e.preventDefault();
        try {
          window.location.href = 'index.html';
        } catch (err) {
          window.location.href = '/';
        }
      });

      // Preview do avatar ao selecionar arquivo + drag & drop
      (function() {
        const dropzone = document.getElementById('avatar-dropzone');
        const chooseBtn = document.getElementById('choose-avatar-btn');
        const removeBtn = document.getElementById('remove-avatar-btn');
        const spinner = document.getElementById('profile-save-spinner');
        const saveMsg = document.getElementById('profile-save-msg');

        function readFileAsDataURL(file) {
          return new Promise((res, rej) => {
            const r = new FileReader();
            r.onload = () => res(r.result);
            r.onerror = () => rej(new Error('Falha ao ler arquivo'));
            r.readAsDataURL(file);
          });
        }

        // Choose button opens native file picker
        chooseBtn && chooseBtn.addEventListener('click', function() {
          fileInput && fileInput.click();
        });

        // Remove avatar -> reset to default
        removeBtn && removeBtn.addEventListener('click', function() {
          if (confirm('Remover avatar atual?')) {
            avatarPreview.src = 'logo.png';
            // Clear file input
            if (fileInput) { fileInput.value = ''; }
          }
        });

        // File input change
        if (fileInput && avatarPreview) {
          fileInput.addEventListener('change', async function () {
            const f = fileInput.files && fileInput.files[0];
            if (!f) {
              avatarPreview.src = avatarEl.src || 'logo.png';
              return;
            }
            try {
              const data = await readFileAsDataURL(f);
              avatarPreview.src = data;
            } catch (e) {
              console.warn('Erro ao ler imagem:', e);
            }
          });
        }

        // Drag & drop support
        if (dropzone) {
          // Clique e teclado (Enter/Espaço) disparam seletor de arquivo
          dropzone.addEventListener('click', function(){ fileInput && fileInput.click(); });
          dropzone.addEventListener('keydown', function(e){
            if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); fileInput && fileInput.click(); }
          });
          dropzone.addEventListener('dragover', function(e) { e.preventDefault(); dropzone.style.borderColor = '#60a5fa'; });
          dropzone.addEventListener('dragleave', function(e) { dropzone.style.borderColor = '#cbd5e1'; });
          dropzone.addEventListener('drop', async function(e) {
            e.preventDefault(); dropzone.style.borderColor = '#cbd5e1';
            const f = e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0];
            if (!f) return;
            if (!f.type.startsWith('image/')) { alert('Por favor, selecione uma imagem.'); return; }
            try {
              const data = await readFileAsDataURL(f);
              avatarPreview.src = data;
              // populate fileInput (not all browsers allow setting FileList programmatically) -- we keep UI in sync
              if (fileInput) { fileInput.files = e.dataTransfer.files; }
            } catch (err) { console.warn('Erro ao processar imagem:', err); }
          });
        }

        // Helpers para spinner / mensagem
        function showSpinner() { spinner && spinner.classList.remove('d-none'); saveMsg && saveMsg.classList.add('d-none'); }
        function hideSpinner() { spinner && spinner.classList.add('d-none'); }
        function showSavedMsg() { saveMsg && (saveMsg.classList.remove('d-none')); }

        // Submissão do formulário de edição (com spinner, feedback e dispatch de evento)
        if (form) {
          form.addEventListener('submit', async function (ev) {
            ev.preventDefault();
            const saveBtn = document.getElementById('profile-save-btn');
            const newName = nameInput ? nameInput.value.trim() : '';
            const newBio = bioInput ? bioInput.value.trim() : '';
            let photoDataURL = null;

            try {
              // Ler imagem se existir
              if (fileInput && fileInput.files && fileInput.files[0]) {
                photoDataURL = await readFileAsDataURL(fileInput.files[0]);
              }

              // UI: spinner + disable
              showSpinner();
              if (saveBtn) saveBtn.disabled = true;

              let updatedUser = null;

              // Tenta atualizar via Firebase Auth se disponível
              if (window.auth && window.auth.currentUser) {
                try {
                  const authModule2 = await import('https://www.gstatic.com/firebasejs/10.12.1/firebase-auth.js');
                  const { updateProfile } = authModule2;
                  const user = window.auth.currentUser;
                  const updates = {};
                  if (newName) updates.displayName = newName;
                  if (photoDataURL) updates.photoURL = photoDataURL; // em produção, suba a Storage
                  await updateProfile(user, updates);
                  updatedUser = Object.assign({}, user, updates);
                  // Atualiza UI local
                  fillUser({
                    displayName: updatedUser.displayName || newName,
                    email: user.email,
                    photoURL: updatedUser.photoURL || avatarEl.src,
                    bio: newBio || '',
                    uid: user.uid,
                    metadata: user.metadata || {}
                  });
                } catch (errUpdate) {
                  console.warn('Falha ao atualizar via Firebase:', errUpdate);
                }
              }

              // Se não atualizou via Firebase, salva localmente
              let finalUserObj = null;
              if (!updatedUser) {
                const local = getLocalUser() || {};
                const demoUpdate = {
                  displayName: newName || local.displayName,
                  // Use a nova imagem se ela existir, senão mantenha a antiga
                  photoURL: photoDataURL || avatarPreview.src, 
                  bio: newBio || local.bio,
                  email: local.email || emailEl.textContent,
                  metadata: local.metadata || { creationTime: new Date().toISOString() }
                };
                saveLocalUser(demoUpdate);
                fillUser(demoUpdate);
                finalUserObj = demoUpdate;
              } else {
                // atualizar também localStorage para consistência
                const up = {
                  displayName: updatedUser.displayName || newName,
                  photoURL: updatedUser.photoURL || avatarPreview.src,
                  bio: newBio || '',
                  email: updatedUser.email || (getLocalUser() && getLocalUser().email) || emailEl.textContent,
                  metadata: updatedUser.metadata || {}
                };
                saveLocalUser(up);
                finalUserObj = up;
              }

              // Dispatch global event para atualizar header/UI
              try {
                document.dispatchEvent(new CustomEvent('auth-changed', { detail: finalUserObj }));
              } catch (ee) { console.debug('Não foi possível dispatch auth-changed:', ee); }

              // Feedback
              hideSpinner();
              showSavedMsg();
              setTimeout(() => { hideModal(); saveBtn && (saveBtn.disabled = false); saveMsg && saveMsg.classList.add('d-none'); }, 900);
            } catch (err) {
              console.error('Erro ao atualizar perfil:', err);
              hideSpinner();
              if (saveBtn) saveBtn.disabled = false;
              alert('Erro ao atualizar perfil: ' + (err && err.message ? err.message : err));
            }
          });
        }
      })();

      // Ao carregar a página: inicializa observador de autenticação/fallback
      document.addEventListener('DOMContentLoaded', function () {
        initAuthObserver();
      });

      // Small UI animations: animate counters and show verified badge
      function animateCounts() {
        document.querySelectorAll('.count').forEach(function(el) {
          const target = parseInt(el.getAttribute('data-target') || el.textContent || '0', 10) || 0;
          const start = 0;
          const duration = 900;
          let startTime = null;
          function step(ts) {
            if (!startTime) startTime = ts;
            const progress = Math.min((ts - startTime) / duration, 1);
            const value = Math.floor(progress * (target - start) + start);
            el.textContent = value;
            if (progress < 1) requestAnimationFrame(step);
            else el.textContent = String(target);
          }
          requestAnimationFrame(step);
        });
      }

      function markVerifiedIfNeeded(user) {
        try {
          const badge = document.getElementById('verified-badge');
          if (!badge) return;
          const isVerified = (user && (user.emailVerified || (user.email && user.email.endsWith('@example.com') && false))) || false;
          if (isVerified) badge.style.display = 'inline-flex';
          else badge.style.display = 'none';
        } catch (e) { /* silent */ }
      }

      // Trigger animations after fillUser is called — wrap existing fillUser
      const origFillUser = window.fillUser || null;
      // If fillUser exists in this scope, it's the inner function; we will call animateCounts after initAuthObserver fires
      document.addEventListener('DOMContentLoaded', function () {
        // Small delay to allow data to render
        setTimeout(function() {
          // populate data-target attributes from content so counts animate to correct numbers
          document.querySelectorAll('#profile-relatos-count, #profile-upvotes').forEach(function(el){
            const v = parseInt(el.textContent || el.getAttribute('data-target') || '0', 10) || 0;
            el.setAttribute('data-target', String(v));
            el.textContent = '0';
          });
          animateCounts();
          // mark verified based on localStorage/user
          let local = null;
          try { local = JSON.parse(localStorage.getItem('user')||'null'); } catch(e){ local = null; }
          const candidate = (window.auth && window.auth.currentUser) || local;
          markVerifiedIfNeeded(candidate);
          // Entry animation: add class then activate
          try {
            const card = document.querySelector('.profile-card');
            if (card) {
              card.classList.add('card-enter');
              // force reflow then activate (ensures transition)
              requestAnimationFrame(() => requestAnimationFrame(() => card.classList.add('active')));
            }
          } catch (e) { console.warn('entry animation error', e); }
          // Configurações removidas do profile; rolagem por âncora não é mais necessária.
        }, 450);
      });

      // Handlers para modal de Segurança e Acesso
      document.addEventListener('DOMContentLoaded', function () {
        const secModal = document.getElementById('security-modal');
        const secClose = document.querySelectorAll('.security-close');
        const linkPrivacy = document.getElementById('link-privacy');
        const securityEmail = document.getElementById('security-email');
        const sendResetBtn = document.getElementById('send-reset-btn');
        const localResetBtn = document.getElementById('local-reset-btn');
        const revokeSessionsBtn = document.getElementById('revoke-sessions-btn');
        const sessionsList = document.getElementById('sessions-list');
        const toggle2fa = document.getElementById('toggle-2fa');

        function openSecModal() {
          if (!secModal) return;
          secModal.classList.add('d-flex');
          secModal.style.setProperty('display','flex','important');
          secModal.setAttribute('aria-hidden','false');
          // preencher email
          const local = (function(){ try { return JSON.parse(localStorage.getItem('user')||'null'); } catch(e){return null;} })();
          const candidate = (window.auth && window.auth.currentUser && window.auth.currentUser.email) || (local && local.email) || document.getElementById('profile-email') && document.getElementById('profile-email').textContent || '';
          if (securityEmail) securityEmail.textContent = candidate || '—';
          // placeholder sessions
          if (sessionsList) sessionsList.textContent = 'Nenhuma sessão detectada localmente.';
        }

        function closeSecModal() {
          if (!secModal) return;
          secModal.classList.remove('d-flex');
          secModal.style.setProperty('display','none','important');
          secModal.setAttribute('aria-hidden','true');
        }

        linkPrivacy && linkPrivacy.addEventListener('click', function(e){ e.preventDefault(); openSecModal(); });
        secClose && secClose.forEach(btn => btn.addEventListener('click', function(ev){ ev.preventDefault(); closeSecModal(); }));
        if (secModal) secModal.addEventListener('click', function(ev){ if (ev.target === secModal) closeSecModal(); });

        // Enviar email de redefinição de senha via Firebase Auth (se disponível)
        sendResetBtn && sendResetBtn.addEventListener('click', async function(e){
          e.preventDefault();
          const email = securityEmail ? securityEmail.textContent : null;
          if (!email) { alert('Email não disponível.'); return; }
          try {
            if (window.firebase && window.firebase.auth && window.firebase.auth().sendPasswordResetEmail) {
              // SDK namespace: firebase.auth().sendPasswordResetEmail
              await window.firebase.auth().sendPasswordResetEmail(email);
              alert('Email de redefinição enviado para ' + email);
            } else if (window.auth && window.firebase) {
              // tenta usar nova API modular se exposta
              try {
                const authMod = await import('https://www.gstatic.com/firebasejs/10.12.1/firebase-auth.js');
                const { sendPasswordResetEmail } = authMod;
                await sendPasswordResetEmail(window.auth, email);
                alert('Email de redefinição enviado para ' + email);
              } catch (modErr) {
                console.warn('Modular sendPasswordResetEmail falhou:', modErr);
                alert('Não foi possível enviar o email de redefinição: serviço não disponível.');
              }
            } else {
              // fallback: modo demo
              alert('Serviço de autenticação não disponível — em modo demo você pode redefinir a senha manualmente nas configurações do backend.');
            }
          } catch (err) {
            console.error('Erro ao enviar email de redefinição:', err);
            alert('Erro ao enviar email de redefinição: ' + (err && err.message ? err.message : err));
          }
        });

        // Fallback local — apenas marca no localStorage
        localResetBtn && localResetBtn.addEventListener('click', function(e){
          e.preventDefault();
          const email = securityEmail ? securityEmail.textContent : null;
          if (!email) { alert('Email não disponível.'); return; }
          const local = (function(){ try { return JSON.parse(localStorage.getItem('user')||'null'); } catch(e){return null;} })() || {};
          local.passwordResetRequested = new Date().toISOString();
          localStorage.setItem('user', JSON.stringify(local));
          alert('Modo demo: redefinição marcada localmente para ' + email);
        });

        revokeSessionsBtn && revokeSessionsBtn.addEventListener('click', function(e){
          e.preventDefault();
          if (!confirm('Revogar todas as sessões para esta conta? (apenas placeholder em modo demo)')) return;
          // Em produção, chamar endpoint administrativo para revogar tokens
          // Aqui fazemos fallback local
          try {
            const local = (function(){ try { return JSON.parse(localStorage.getItem('user')||'null'); } catch(e){return null;} })();
            if (local) { local.sessionsRevokedAt = new Date().toISOString(); localStorage.setItem('user', JSON.stringify(local)); }
            if (sessionsList) sessionsList.textContent = 'Sessões revogadas localmente.';
            alert('Sessões revogadas (modo demo).');
          } catch (ee) { console.warn('Erro ao revogar sessões localmente', ee); alert('Erro ao tentar revogar sessões.'); }
        });

        // Toggle 2FA placeholder — salva preferência local
        toggle2fa && toggle2fa.addEventListener('change', function(e){
          try {
            const local = (function(){ try { return JSON.parse(localStorage.getItem('user')||'null'); } catch(e){return null;} })() || {};
            local.twoFactorEnabled = !!toggle2fa.checked;
            localStorage.setItem('user', JSON.stringify(local));
            alert('Configuração 2FA atualizada (modo demo): ' + (toggle2fa.checked ? 'Ativado' : 'Desativado'));
          } catch (err) { console.warn('Erro ao salvar 2FA localmente', err); }
        });
      });

    })();
  </script>

  <!-- Optionally include Bootstrap JS (not required for modal here) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" defer></script>
</body>
</html>
