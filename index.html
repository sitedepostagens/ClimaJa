</body>
<script>
    // Função para calcular intensidade dos relatos próximos
    function calcularIntensidadeRelatos(relatos, lat, lon) {
      let intensidade = 0;
      relatos.forEach(r => {
        if (r.latitude && r.longitude) {
          const dist = Math.sqrt(Math.pow(r.latitude - lat, 2) + Math.pow(r.longitude - lon, 2));
          if (dist < 0.08) { // ~8km
            if (r.nivel === '1.5') intensidade += 3;
            else if (r.nivel === '1.0') intensidade += 2;
            else if (r.nivel === '0.5') intensidade += 1.5;
            else if (r.nivel === '0.2') intensidade += 1;
            else if (r.nivel === '0') intensidade += 0.2;
          }
        }
      });
      return intensidade;
    }

    // Atualiza o mapa Windy conforme relatos e localização
    async function atualizarMapaWindy() {
      if (!userLocation) return;
      // Buscar relatos públicos do Firestore
      let relatos = [];
      try {
        const db = getFirestore();
        const q = query(collection(db, "relatos"), orderBy("dataHora", "desc"), limit(50));
        const querySnapshot = await getDocs(q);
        querySnapshot.forEach(doc => relatos.push(doc.data()));
      } catch (e) { /* fallback: sem relatos */ }
      // Calcular intensidade
      const intensidade = calcularIntensidadeRelatos(relatos, userLocation.lat, userLocation.lon);
      // Definir overlay e zoom
      let overlay = 'rain';
      let zoom = 13;
      if (intensidade >= 6) { overlay = 'thunder'; zoom = 15; }
      else if (intensidade >= 3) { overlay = 'rain'; zoom = 14; }
      else if (intensidade >= 1.5) { overlay = 'wind'; zoom = 13; }
      else { overlay = 'temp'; zoom = 12; }
      var windyFrame = document.getElementById('windy-embed');
      if (windyFrame) {
        windyFrame.src = `https://embed.windy.com/embed2.html?lat=${userLocation.lat}&lon=${userLocation.lon}&detailLat=${userLocation.lat}&detailLon=${userLocation.lon}&width=650&height=450&zoom=${zoom}&level=surface&overlay=${overlay}&product=ecmwf`;
      }
    }
// Função global para fechar a interface de seleção de localização (modal ou div customizada)
function fecharSelecaoLocalizacao() {
  // Exemplo para modal Bootstrap
  const modal = document.getElementById('modal-selecao-local');
  // Mapa inicializado pelo script principal (script.js) para evitar duplicidade
  if (!modal) return;
  // Se for um modal Bootstrap, tente fechar via API do Bootstrap
  try {
    if (window.bootstrap && bootstrap.Modal) {
      const inst = bootstrap.Modal.getInstance(modal);
      if (inst) inst.hide();
    }
  } catch (e) {
    // fallback: remover classe show
    modal.classList.remove('show');
    modal.style.display = 'none';
  }
}
</script>

<script>
        window.ezstandalone = window.ezstandalone || {};
            ezstandalone.cmd = ezstandalone.cmd || [];
            </script>
            <meta name="keywords" content="nexuscloud, necus cloud, NexusCloud, nexus Cloud, nuvem, guardar arquivos, guardar fotos, nuvem de fotos gratis, nuvem gratuita, drive, drive gratuito">
            <script type="application/ld+json">
            {
              "@context": "https://schema.org",
              "@type": "WebSite",
              "name": "ClimaJá",
              "url": "/",
              "description": "O ClimaJá! é uma plataforma colaborativa para monitoramento meteorológico e relatos de alagamentos em tempo real. O objetivo é ajudar pessoas a se informarem sobre as condições do clima e compartilharem informações úteis para a sociedade, promovendo segurança e prevenção.",
              "potentialAction": {
                "@type": "SearchAction",
                "target": "https://oclimaja.netlify.app/?q={search_term_string}",
                "query-input": "required name=search_term_string"
              },
              "contactPoint": {
                "@type": "ContactPoint",
                "contactType": "customer support",
                "email": "oclimaja@hotmail.com",
                "url": "mailto:oclimaja@hotmail.com",
                "availableLanguage": "Portuguese"
              }
            }
            </script>
            <meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="manifest" href="/manifest.json">
<link rel="icon" type="image/png" href="logo.png">
<link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
  <!-- CSS externos -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/weather-icons/2.0.12/css/weather-icons.min.css">
  <!-- Nosso CSS -->
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="animacao-global.css">
  <style>
    /* Forçar bordas arredondadas nas principais áreas para visual consistente */
    .main-card, .main-card.animada, .tab-pane, .tab-pane .main-card, #map, .relato-card, .weather-header, .weather-grid {
      border-radius: 1.2rem !important;
    }
    /* Ajuste mais suave para inputs e botões */
    .form-control, .btn, .dropdown-menu {
      border-radius: 0.8rem !important;
    }
    /* Certifique-se que popups do leaflet estejam arredondados */
    .leaflet-popup-content-wrapper {
      border-radius: 1rem !important;
    }

    /* Centralizar conteúdo das seções principais */
    .container.my-4 {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .tab-content {
      width: 100%;
      max-width: 1100px;
      margin: 0 auto;
    }
    .main-card {
      margin-left: auto !important;
      margin-right: auto !important;
    }
    #relatos-publicos {
      max-width: 1000px;
      margin-left: auto;
      margin-right: auto;
    }

    /* Área de login/cadastro: visual moderno, espaçamento, gradiente, bordas arredondadas */
    .login-cadastro-area {
      display: flex;
      gap: 0.7rem;
      align-items: center;
      padding: 0.5rem 1.2rem;
      background: linear-gradient(90deg, #e0f2fe 60%, #f9f871 100%);
      border-radius: 1.2rem;
      box-shadow: 0 2px 12px #2563eb22;
      border: 2px solid #38bdf8;
      margin-right: 1.2rem;
      margin-top: 0.5rem;
      margin-bottom: 0.5rem;
    }
    .login-cadastro-area .btn {
      border-radius: 0.7rem;
      font-weight: 700;
      box-shadow: 0 2px 8px #2563eb11;
      transition: background 0.3s, color 0.3s, box-shadow 0.3s;
    }
    .login-cadastro-area .btn-outline-primary {
      background: #fff;
      color: #2563eb;
      border: 2px solid #38bdf8;
    }
    .login-cadastro-area .btn-outline-primary:hover {
      background: #bae6fd;
      color: #232946;
      box-shadow: 0 2px 12px #38bdf822;
    }
    .login-cadastro-area .btn-outline-light {
      background: #f9f871;
      color: #232946;
      border: 2px solid #fbbf24;
    }
    .login-cadastro-area .btn-outline-light:hover {
      background: #fbbf24;
      color: #fff;
      box-shadow: 0 2px 12px #fbbf2433;
    }
    @media (max-width: 600px) {
      .login-cadastro-area {
        flex-direction: column;
        gap: 0.4rem;
        padding: 0.3rem 0.5rem;
        margin-right: 0.2rem;
      }
    }
    /* Garante que a área de dados do perfil nunca muda de cor, nem em hover, focus ou active */
    #perfil-dados.dropdown-item,
    #perfil-dados.dropdown-item:hover,
    #perfil-dados.dropdown-item:focus,
    #perfil-dados.dropdown-item:active {
      background: inherit !important;
      color: inherit !important;
      cursor: default;
      box-shadow: none !important;
    }
    /* Não aplicar hover na área de dados do perfil */
    #perfil-dados.dropdown-item:hover {
      background: inherit !important;
      color: inherit !important;
      cursor: default;
    }
    /* Perfil Dropdown: Gradiente, bordas arredondadas, paleta azul/aqua/amarelo */
    .dropdown-menu[aria-labelledby="perfilDropdown"] {
      background: #fff;
      border-radius: 1.5rem;
      box-shadow: 0 8px 32px -8px #2563eb44, 0 0 40px 0 #5ee7df33 inset;
      border: 2px solid #38bdf8;
      padding: 1.2rem 1rem 1rem 1rem;
      animation: sobreFadeIn 0.8s cubic-bezier(.23,1.02,.32,1) both;
    }
    .dropdown-menu[aria-labelledby="perfilDropdown"] .dropdown-item {
      border-radius: 1rem;
      margin-bottom: 0.5rem;
      background: rgba(255,255,255,0.85);
      color: #232946;
      font-weight: 600;
      transition: background 0.3s, color 0.3s;
    }
    .dropdown-menu[aria-labelledby="perfilDropdown"] .dropdown-item:hover {
      background: rgba(56, 189, 248, 0.09); /* azul claro, ainda mais transparente */
      color: #2563eb;
    }
    #perfil-dados {
      background: linear-gradient(120deg, #e0f2fe 60%, #f9f871 100%);
      border-radius: 1.2rem;
      box-shadow: 0 2px 12px #2563eb22;
      padding: 1rem 0.5rem 0.7rem 0.5rem;
      margin-bottom: 0.7rem;
    }
    #perfil-dados img {
      border: 3px solid #38bdf8;
      box-shadow: 0 2px 12px #5ee7df44;
    }
    /* Melhorias visuais e responsivas para o cartão de perfil (evita truncamento do e-mail) */
    /* Nome curto exibido no botão do header */
    #perfil-nome-area {
      max-width: 160px;
      display: inline-block;
      vertical-align: middle;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    /* No dropdown, permitir quebra de linha para e-mails longos e melhorar legibilidade */
    #perfil-nome {
      color: #2563eb;
      font-weight: 800;
      font-size: 1.1rem; /* ligeiramente menor para evitar estouro */
      word-break: break-word;
      overflow-wrap: anywhere;
      margin-bottom: 4px;
    }
    #perfil-email {
      color: #3a506b;
      font-size: 0.95rem;
      font-weight: 600;
      white-space: normal !important;
      word-break: break-word !important;
      overflow-wrap: anywhere !important;
      max-width: 260px;
      margin-left: auto;
      margin-right: auto;
    }
  /* botão de cópia removido - seletores limpos */
    /* Tooltip simples (texto temporário) */
    .copy-feedback {
      position: absolute;
      z-index: 9999;
      background: rgba(0,0,0,0.8);
      color: #fff;
      padding: 6px 8px;
      border-radius: 0.5rem;
      font-size: 0.85rem;
      transform: translateY(-8px);
      opacity: 0;
      transition: opacity 180ms ease-in-out, transform 180ms ease-in-out;
    }
    .copy-feedback.show { opacity: 1; transform: translateY(-12px); }
    /* animação slide-up para dropdown mobile */
    .dropdown-slide-up {
      animation: slideUpIn 320ms cubic-bezier(.2,.9,.2,1) both;
      transform-origin: bottom center;
    }
    @keyframes slideUpIn {
      from { opacity: 0; transform: translateY(12px) scale(.995); }
      to   { opacity: 1; transform: translateY(0) scale(1); }
    }
    /* esconder avatar em telas muito pequenas para economizar espaço */
    @media (max-width: 420px) {
      #perfil-dados img { display: none !important; }
      #perfil-nome { font-size: 0.98rem; }
      #perfil-email { font-size: 0.88rem; }
    }
    #perfil-nome {
      color: #2563eb;
      font-weight: 800;
      font-size: 1.3rem;
      text-shadow: 0 2px 8px #bae6fd99;
    }
    #perfil-email {
      color: #3a506b;
      font-size: 1rem;
      font-weight: 500;
    }
    .badge.bg-primary {
      background: linear-gradient(90deg, #38bdf8 60%, #f9f871 100%);
      color: #232946;
      font-weight: 700;
      border-radius: 0.7rem;
      box-shadow: 0 2px 8px #2563eb22;
    }
    #logout-btn {
      border-radius: 0.7rem;
      font-weight: 700;
      background: linear-gradient(90deg, #f87171 60%, #fbbf24 100%);
      color: #232946;
      border: none;
      box-shadow: 0 2px 8px #f8717133;
      transition: background 0.3s, color 0.3s;
    }
    #logout-btn:hover {
      background: linear-gradient(90deg, #fbbf24 60%, #f87171 100%);
      color: #fff;
    }
    @media (max-width: 600px) {
      .dropdown-menu[aria-labelledby="perfilDropdown"] {
        min-width: 90vw;
        padding: 1.1rem 0.3rem 1rem 0.3rem;
      }
      #perfil-dados {
        padding: 0.7rem 0.2rem 0.5rem 0.2rem;
      }
    }
    [data-theme="dark"] .dropdown-menu[aria-labelledby="perfilDropdown"] {
      background: linear-gradient(120deg, #1e293b 60%, #0f172a 100%) !important;
      color: #f8fafc !important;
      border-color: #60a5fa;
    }
    [data-theme="dark"] #perfil-dados {
      background: linear-gradient(120deg, #334155 60%, #1e293b 100%) !important;
      color: #f8fafc !important;
      border-color: #60a5fa;
    }
    [data-theme="dark"] #perfil-nome {
      color: #60a5fa !important;
      text-shadow: 0 2px 8px #0f172a99;
    }
    [data-theme="dark"] #perfil-email {
      color: #f8fafc !important;
    }
    [data-theme="dark"] .badge.bg-primary {
      background: linear-gradient(90deg, #60a5fa 60%, #f9f871 100%) !important;
      color: #232946 !important;
    }
    [data-theme="dark"] #logout-btn {
      background: linear-gradient(90deg, #f87171 60%, #fbbf24 100%) !important;
      color: #232946 !important;
    }
    [data-theme="dark"] #logout-btn:hover {
      background: linear-gradient(90deg, #fbbf24 60%, #f87171 100%) !important;
      color: #fff !important;
    }
  </style>
  <!-- Regras responsivas adicionais -->
  <style>
    /* Imagens e iframes fluidos */
    img, .footer-logo-img { max-width: 100%; height: auto; display: inline-block; }
    iframe, embed, object { max-width: 100%; width: 100%; height: auto; }

    /* Tipografia responsiva para o título principal */
    .project-title { font-size: clamp(1.6rem, 4.0vw + 1rem, 3.7rem); }
    .project-desc { font-size: clamp(1rem, 2.2vw + 0.5rem, 2rem); }

    /* Tornar o mapa responsivo: altura adaptativa, não exceder um máximo */
    #map { height: min(60vh, 600px); width: 100%; }
    /* Se houver iframe do Windy, garantir altura proporcional (16:9) e responsivo */
    #windy-embed { width: 100% !important; height: calc(100vw * 9 / 16); max-height: 600px; }

    /* Botões e inputs: empilhamento em telas pequenas */
    @media (max-width: 760px) {
      .login-cadastro-area { flex-direction: column; align-items: stretch; }
      .d-flex.justify-content-center.gap-2 { flex-direction: column; gap: 0.5rem; }
      .weather-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.6rem; }
    }

    @media (max-width: 420px) {
      .weather-grid { grid-template-columns: 1fr; }
      .main-header .logo-box { height: 70px; width: 90px; }
      .main-header img { height: 56px; width: 72px; }
    }
  </style>
  <style>
    /* HEADER: degradê surpreendente, harmônico e temático (clima/meteorologia) */
    .main-header {
      /* Fundo: gradiente multicolorido com "aurora boreal" + "céu" + "chuva" + "sol" */
      background: linear-gradient(120deg,
        #232946 0%,      /* noite/aurora escura */
        #3a506b 10%,     /* azul petróleo/frio */
        #5ee7df 22%,     /* verde água/aurora */
        #b3e0ff 35%,     /* azul claro/inverno */
        #f9f871 55%,     /* amarelo sol */
        #fbbf24 65%,     /* dourado quente */
        #fca5a5 75%,     /* rosa/aurora */
        #a5b4fc 85%,     /* lilás/chuva */
        #232946 100%     /* noite/aurora escura */
      );
      background-size: 300% 300%;
      animation: gradienteAnimado 16s ease-in-out infinite alternate;
    @keyframes gradienteAnimado {
      0% {
        background-position: 0% 50%;
      }
      50% {
        background-position: 100% 50%;
      }
      100% {
        background-position: 0% 50%;
      }
    }
      background-size: 300% 300%;
      animation: gradienteAnimado 16s ease-in-out infinite alternate;
      color: #fff;
      box-shadow: 0 8px 32px -8px #2563eb44, 0 0 120px 0 #5ee7df33 inset;
      padding: 2.2rem 1.2rem 1.5rem 1.2rem;
      margin-bottom: 2.5rem;
      display: flex;
      align-items: center;
      gap: 2rem;
      justify-content: center;
      flex-wrap: wrap;
      border-radius: 0 0 2.5rem 2.5rem;
      border: 2px solid #38bdf8;
      position: relative;
      overflow: hidden;
      transition: background 0.7s;
      /* Efeito "neblina"/"aurora" animada */
      isolation: isolate;
    }

    @keyframes gradienteAnimado {
      0% {
        background-position: 0% 50%;
      }
      50% {
        background-position: 100% 50%;
      }
      100% {
        background-position: 0% 50%;
      }
    }
    .main-header::before {
      content: "";
      position: absolute;
      inset: 0;
      z-index: 0;
      pointer-events: none;
      background: radial-gradient(ellipse 80% 40% at 60% 0%, #f9f87155 0%, #fbbf2433 40%, transparent 100%),
                  radial-gradient(ellipse 60% 30% at 20% 20%, #5ee7df44 0%, #a5b4fc33 60%, transparent 100%),
                  radial-gradient(ellipse 40% 20% at 80% 80%, #fca5a522 0%, transparent 100%);
      opacity: 0.85;
      animation: auroraMove 12s ease-in-out infinite alternate;
    }
    @keyframes auroraMove {
      0% { background-position: 60% 0%, 20% 20%, 80% 80%; }
      100% { background-position: 50% 10%, 30% 30%, 70% 70%; }
    }
    .main-header::after {
      /* Efeito "chuva" sutil */
      content: "";
      position: absolute;
      inset: 0;
      z-index: 1;
      pointer-events: none;
      background-image: repeating-linear-gradient(120deg, #fff2 0 2px, transparent 2px 20px);
      opacity: 0.13;
      animation: chuvaMove 7s linear infinite;
    }
    @keyframes chuvaMove {
      0% { background-position: 0 0; }
      100% { background-position: 60px 60px; }
    }
    .main-header > * {
      position: relative;
      z-index: 2;
    }
    /* Remove degradês individuais, agora é um só harmônico */
    .main-header .logo-box {
      background: none; /* Remove o fundo branco */
      border-radius: 1.5rem;
      box-shadow: 0 2px 12px #2563eb22;
      padding: 0.4rem 1.1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 170px; /* Aumenta ainda mais a altura */
      width: 200px;  /* Aumenta bastante a largura */
      transition: transform 0.3s;
    }
    .main-header img {
      height: 140px; /* Aumenta ainda mais a logo */
      width: 180px;  /* Deixa a logo mais larga */
      object-fit: contain;
      border-radius: 1rem;
      background: none;
      box-shadow: none;
      padding: 0;
      transition: transform 0.3s;
    }
    .main-header .project-title {
      font-size: 3.7rem; /* Título ainda maior */
      font-weight: 900;
      letter-spacing: 2.5px;
      margin-bottom: 0.4rem;
      color: #fff;
      text-shadow: 0 2px 12px #2563eb44;
    }
    .main-header .project-desc {
      font-size: 2rem; /* Subtítulo maior */
      font-weight: 600;
      opacity: 0.98;
      color: #e0e7ff;
    }
    /* Ajuste para o container do mapa */
    #map {
      min-height: 350px;
      height: 60vh;
      border-radius: 1rem;
      border: 1.5px solid var(--primary);
      background: var(--card-bg);
      box-shadow: 0 2px 12px #2563eb22;
      margin-bottom: 1rem;
    }
    /* Animações para login/cadastro */
    .fade-in {
      animation: fadeInLogin 0.5s;
    }
    .fade-out {
      animation: fadeOutLogin 0.4s forwards;
    }
    @keyframes fadeInLogin {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: none; }
    }
    @keyframes fadeOutLogin {
      from { opacity: 1; }
      to { opacity: 0; transform: translateY(-20px); }
    }
    .form-control:invalid {
      border-color: #dc2626;
      box-shadow: 0 0 0 2px #dc262622;
    }
    .form-control:valid {
      border-color: #22c55e;
      box-shadow: 0 0 0 2px #22c55e22;
    }
    .form-feedback {
      font-size: 0.95rem;
      color: #dc2626;
      margin-top: -0.7rem;
      margin-bottom: 0.7rem;
      display: none;
    }
    .form-feedback.active {
      display: block;
    }
    /* Animação para o quadro Sobre o Projeto e Clima */
    .main-card.sobre-anim, .main-card.clima-anim {
      animation: sobreFadeIn 1.1s cubic-bezier(.23,1.02,.32,1) both;
      box-shadow: 0 8px 32px -8px #2563eb33, 0 1.5px 12px #38bdf822;
      border: 2px solid #38bdf8;
      background: linear-gradient(120deg, #f0f9ff 60%, #e0f2fe 100%);
      transition: box-shadow 0.4s, border 0.4s, background 0.4s, transform 0.35s cubic-bezier(.23,1.02,.32,1);
    }
    .tab-pane#clima .main-card.clima-anim {
      cursor: pointer;
      transition: box-shadow 0.4s, border 0.4s, background 0.4s, transform 0.35s cubic-bezier(.23,1.02,.32,1);
    }
    .tab-pane#clima .main-card.clima-anim:hover {
      transform: scale(1.045) translateY(-8px);
      box-shadow: 0 20px 56px -8px #2563eb55, 0 8px 32px #38bdf855;
      border-color: #2563eb;
      background: linear-gradient(120deg, #e0f2fe 60%, #bae6fd 100%);
    }
    @keyframes sobreFadeIn {
      0% {
        opacity: 0;
        transform: scale(0.97) translateY(40px) skewY(2deg);
        filter: blur(6px);
      }
      60% {
        opacity: 1;
        filter: blur(0.5px);
      }
      100% {
        opacity: 1;
        transform: scale(1) translateY(0) skewY(0);
        filter: blur(0);
      }
    }
    @media (max-width: 600px) {
      .main-header {
        flex-direction: column;
        gap: 0.7rem;
        padding: 1.1rem 0.3rem 1.1rem 0.3rem;
      }
      .main-header .logo-box {
        height: 80px;
        width: 110px;
        padding: 0.2rem 0.7rem;
        border-radius: 1.1rem;
      }
      .main-header img {
        height: 60px;
        width: 90px;
        border-radius: 0.7rem;
      }
      .main-header .project-title {
        font-size: 1.7rem;
      }
      .main-header .project-desc {
        font-size: 1.15rem;
      }
      .container.my-4 {
        padding-left: 0.2rem;
        padding-right: 0.2rem;
      }
    }
    /* Ajustes específicos para mobile: dropdown de perfil full-width e regras de compactação */
    @media (max-width: 760px) {
      .dropdown-menu[aria-labelledby="perfilDropdown"] {
        position: fixed !important;
        left: 8px !important;
        right: 8px !important;
        bottom: 14px !important;
        top: auto !important;
        min-width: unset !important;
        width: calc(100% - 16px) !important;
        max-width: calc(100% - 16px) !important;
        border-radius: 1rem !important;
        padding: 0.9rem !important;
        box-shadow: 0 12px 40px rgba(0,0,0,0.18) !important;
      }
      /* compacta o conteúdo do dropdown para caber melhor em telas pequenas */
      #perfil-dados { display: flex; flex-direction: row; align-items: center; gap: 12px; padding: 0.5rem; }
      #perfil-dados img { width: 56px; height: 56px; }
      #perfil-nome { font-size: 1rem; text-align: left; }
      #perfil-email { font-size: 0.9rem; text-align: left; max-width: 100%; }
      .perfil-email-row { justify-content: flex-start; }
  /* botão de cópia removido em mobile também */
      .badge.bg-primary { display: none; }
      /* evita que o header perca espaço com o dropdown fixo */
      body { padding-bottom: 90px; }
    }
    [data-theme="dark"] .main-card.sobre-anim, [data-theme="dark"] .main-card.clima-anim {
      background: linear-gradient(120deg, #1e293b 60%, #0f172a 100%) !important;
      color: #f8fafc !important;
      border-color: #60a5fa;
    }
    [data-theme="dark"] .main-card.sobre-anim h2,
    [data-theme="dark"] .main-card.sobre-anim p,
    [data-theme="dark"] .main-card.clima-anim h2,
    [data-theme="dark"] .main-card.clima-anim p,
    [data-theme="dark"] .main-card.clima-anim .weather-header,
    [data-theme="dark"] .main-card.clima-anim .weather-item,
    [data-theme="dark"] .main-card.clima-anim .sensor-value {
      color: #f8fafc !important;
      text-shadow: 0 2px 8px #0f172a99;
    }
    [data-theme="dark"] .main-card.clima-anim .weather-item {
      background: #1e293bcc !important;
      border-color: #334155 !important;
    }
    [data-theme="dark"] .main-card.clima-anim .weather-icon {
      color: #60a5fa !important;
      filter: drop-shadow(0 2px 8px #60a5fa33);
    }
    .footer-logo-img {
      height: 48px;
      width: auto;
      max-width: 120px;
      object-fit: contain;
      background: transparent;
      border-radius: 0.7rem;
      transition: background 0.3s;
      box-shadow: 0 2px 8px #2563eb11;
      padding: 2px 8px;
    }
    [data-theme="dark"] .footer-logo-img {
      background: #fff;
    }
  </style>
</head>
<body>
  <div class="dynamic-texture" aria-hidden="true"></div>
  <style>
    /* Centralização global do body */
    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      min-height: 100vh;
      background: linear-gradient(120deg, #e0f2fe 60%, #f9f871 100%);
      margin: 0;
      padding: 0;
    }
    /* Container principal mais centralizado e espaçado */
    .container.my-4 {
      margin-top: 2.5rem !important;
      margin-bottom: 2.5rem !important;
      padding: 2.5rem 2rem !important;
      background: rgba(255,255,255,0.95);
      border-radius: 2rem;
      box-shadow: 0 8px 32px -8px #2563eb33, 0 1.5px 12px #38bdf822;
      max-width: 1200px;
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    /* Animação global mais moderna */
    .animada {
      animation: fadeUp 0.8s cubic-bezier(.23,1.02,.32,1) both;
    }
    @keyframes fadeUp {
      0% {
        opacity: 0;
        transform: translateY(40px) scale(0.97);
        filter: blur(6px);
      }
      60% {
        opacity: 1;
        filter: blur(0.5px);
      }
      100% {
        opacity: 1;
        transform: none;
        filter: blur(0);
      }
    }
    /* Animação para o título cidade/bairro */
    #city-name {
      display: inline-block;
      transition: opacity 360ms cubic-bezier(.22,1,.36,1), transform 360ms cubic-bezier(.22,1,.36,1), filter 360ms;
      will-change: opacity, transform;
      backface-visibility: hidden;
    }
    /* Classe aplicada durante troca: esmaece e sobe levemente */
    #city-name.city-switching {
      opacity: 0;
      transform: translateY(-8px) scale(0.985);
      filter: blur(0.6px) contrast(0.98);
    }
    /* Botões: animação de clique e hover */
    .btn, .btn-modern {
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .btn:active, .btn-modern:active {
      transform: scale(0.97);
      box-shadow: 0 2px 12px #2563eb33;
    }
    .btn:hover, .btn-modern:hover {
      transform: scale(1.04);
      box-shadow: 0 8px 32px -8px #2563eb44;
    }
    /* Centralizar nav-pills */
    .nav.nav-pills {
      justify-content: center !important;
      margin-bottom: 2rem !important;
    }
    /* Tab-content ocupa toda a largura disponível */
    .tab-content {
      width: 100%;
      max-width: 1100px;
      margin: 0 auto;
      display: block;
    }
    /* Main-card ocupa toda a largura da aba */
    .main-card {
      margin: 2rem auto !important;
      padding: 2rem 2.5rem !important;
      max-width: 1000px;
      width: 100%;
      box-shadow: 0 8px 32px -8px #2563eb33, 0 1.5px 12px #38bdf822;
      border-radius: 1.5rem;
      background: rgba(255,255,255,0.98);
    }
    /* Responsividade para celular */
    @media (max-width: 600px) {
      .container.my-4 {
        padding: 0.5rem 0.1rem !important;
        margin-top: 0.5rem !important;
        margin-bottom: 0.5rem !important;
        max-width: 100vw;
      }
      .tab-content {
        max-width: 100vw;
        padding: 0 !important;
      }
      .main-card {
        padding: 0.7rem 0.2rem !important;
        margin: 0.7rem auto !important;
        max-width: 99vw;
        width: 100vw;
      }
    }
  </style>
  <!-- Botão de modo escuro removido -->

  <header class="main-header">
    <div class="logo-box">
      <img src="logo.png" alt="Logo ClimaJá!">
    </div>
    <div>
      <div class="project-title">ClimaJá!</div>
      <div class="project-desc">Monitoramento Meteorológico e Relatos de Alagamentos em Tempo Real</div>
    </div>
   <!-- ...código anterior... -->
<div class="d-flex justify-content-end align-items-center pe-3" style="position:absolute;top:1.5rem;right:0;z-index:10;">
  <!-- Botão de perfil substitui login/cadastro quando logado -->
  <div id="perfil-area" class="d-none">
    <div class="dropdown">
      <button class="btn btn-gradient btn-sm fw-bold dropdown-toggle d-flex align-items-center" type="button" id="perfilDropdown" data-bs-toggle="dropdown" aria-expanded="false">
        <img src="logo.png" alt="Avatar" style="width:32px;height:32px;border-radius:50%;margin-right:8px;box-shadow:0 2px 8px #2563eb22;">
        <span id="perfil-nome-area" style="font-weight:600;">Perfil</span>
      </button>
      <ul class="dropdown-menu" aria-labelledby="perfilDropdown" style="min-width:260px;border-radius:0;">
        <li>
          <div class="dropdown-item text-center" id="perfil-dados" style="min-width:220px;padding-bottom:10px;">
            <img src="logo.png" alt="Avatar" style="width:72px;height:72px;border-radius:50%;box-shadow:0 2px 8px #2563eb22;margin-bottom:10px;">
            <div style="font-size:1.15rem;font-weight:800;color:#2563eb;margin-bottom:6px;" id="perfil-nome">-</div>
            <div class="perfil-email-row" style="display:flex;align-items:center;justify-content:center;gap:8px;">
              <div style="font-size:0.95rem;color:#555;margin-bottom:8px;" id="perfil-email">-</div>
            </div>
            <span class="badge bg-primary mb-2" style="font-size:0.9rem;">Usuário ClimaJá!</span>
            <hr style="margin:10px 0 6px 0;">
            <button class="btn btn-danger btn-sm fw-bold w-100" id="logout-btn" type="button">
              <i class="fas fa-sign-out-alt me-1"></i>Sair
            </button>
          </div>
        </li>
        <li><hr class="dropdown-divider"></li>
        <li><a class="dropdown-item" href="profile.html" id="perfil-acessar"><i class="fas fa-user me-1 text-primary"></i>Acessar Perfil</a></li>
        <li><a class="dropdown-item" href="#" id="perfil-relatos"><i class="fas fa-list me-1 text-primary"></i>Meus Relatos</a></li>
        <li><a class="dropdown-item" href="#" id="perfil-ajuda"><i class="fas fa-question-circle me-1 text-info"></i>Ajuda</a></li>
      </ul>
    </div>
  </div>

  <a class="btn btn-outline-primary btn-sm fw-bold me-2" id="baixar-app-btn" href="app.html">
    <i class="fas fa-download me-1"></i>Baixar APP
  </a>
  <!-- botão 'acessar-perfil-btn' removido conforme solicitado (botão da foto) -->
  <a class="btn btn-outline-primary btn-sm fw-bold me-2" id="cadastrar-btn" href="register.html">
    <i class="fas fa-user-plus me-1"></i>Cadastrar
  </a>
  <a class="btn btn-outline-primary btn-sm fw-bold me-2" id="entrar-btn" href="login.html">
    <i class="fas fa-sign-in-alt me-1"></i>Entrar
  </a>
</div>
<!-- Controle de autenticação e exibição do perfil/relato é feito apenas pelo script.js -->
<!-- ...código seguinte... -->
  </header>

  <script>
    (function(){
      // Atualiza a área do header com dados do usuário
      function updateHeaderUser(user) {
        const perfilArea = document.getElementById('perfil-area');
        const entrarBtn = document.getElementById('entrar-btn');
        const cadastrarBtn = document.getElementById('cadastrar-btn');
        const acessarPerfilBtn = document.getElementById('acessar-perfil-btn');
        const perfilNomeArea = document.getElementById('perfil-nome-area');
        const perfilNome = document.getElementById('perfil-nome');
        const perfilEmail = document.getElementById('perfil-email');
          const perfilImgs = document.querySelectorAll('#perfil-area img, #perfil-dados img');

        if (user) {
          // Mostrar área de perfil
          perfilArea && perfilArea.classList.remove('d-none');
          // Ocultar botões de login/cadastro
          entrarBtn && entrarBtn.classList.add('d-none');
          cadastrarBtn && cadastrarBtn.classList.add('d-none');
          acessarPerfilBtn && acessarPerfilBtn.classList.remove('d-none');

          const name = (user.displayName || user.name || '').trim();
          const email = (user.email || '').trim();
          const photo = user.photoURL || user.photo || 'logo.png';

          // Se o nome for igual ao e-mail (usuário sem displayName), evitar duplicação:
          // - No botão do header mostrar apenas a parte antes do @ (mais curta)
          // - No dropdown mostrar o e-mail completo e ocultar a linha extra se redundante
          try {
            if (email && name && name === email) {
              // nome é o e-mail completo
              if (perfilNomeArea) perfilNomeArea.textContent = email.split('@')[0] || email;
              if (perfilNome) {
                perfilNome.textContent = email; // mostra o e-mail completo no título do dropdown
              }
              if (perfilEmail) {
                perfilEmail.style.display = 'none'; // evita mostrar duas linhas iguais
              }
            } else {
              // nomes diferentes — mostrar ambos (nome + e-mail)
              if (perfilNomeArea) perfilNomeArea.textContent = (name || email || 'Usuário');
              if (perfilNome) perfilNome.textContent = (name || '—');
              if (perfilEmail) {
                perfilEmail.style.display = '';
                perfilEmail.textContent = (email || '—');
              }
              // botão de cópia removido — nada a ajustar aqui
            }
          } catch (e) {
            // fallback simples
            if (perfilNomeArea) perfilNomeArea.textContent = name || email || 'Usuário';
            if (perfilNome) perfilNome.textContent = name || email || 'Usuário';
              if (perfilEmail) { perfilEmail.style.display = ''; perfilEmail.textContent = email || '—'; }
          }

          // Atualiza todas as imagens da área de perfil (dropdown + botão)
          perfilImgs && perfilImgs.forEach(img => { img.src = photo; });
          // Atualiza elementos do modal mobile, se existirem
          const modalName = document.getElementById('modal-perfil-nome');
          const modalEmail = document.getElementById('modal-perfil-email');
          const modalImgs = document.querySelectorAll('#perfilModal img');
          if (modalName) modalName.textContent = perfilNome ? perfilNome.textContent : (name || 'Usuário');
          if (modalEmail) modalEmail.textContent = perfilEmail ? perfilEmail.textContent : (email || '—');
          modalImgs && modalImgs.forEach(img => { img.src = photo; });
        } else {
          // Usuário não autenticado — ocultar area de perfil e mostrar botões
          perfilArea && perfilArea.classList.add('d-none');
          entrarBtn && entrarBtn.classList.remove('d-none');
          cadastrarBtn && cadastrarBtn.classList.remove('d-none');
          acessarPerfilBtn && acessarPerfilBtn.classList.add('d-none');
        }
      }

      // Tenta carregar usuário do localStorage como fallback
      function loadLocalUser() {
        try {
          const raw = localStorage.getItem('user');
          if (!raw) return null;
          return JSON.parse(raw);
        } catch (e) { return null; }
      }

      // Inicializa com localStorage e escuta evento global 'auth-changed'
      document.addEventListener('DOMContentLoaded', function(){
        const local = loadLocalUser();
        updateHeaderUser(local);
        // cópia de e-mail removida (recursos do botão e handlers removidos)

        // abrir modal em telas pequenas ao clicar no botão de perfil (em vez do dropdown)
        try {
          const perfilBtn = document.getElementById('perfilDropdown');
          if (perfilBtn) {
            perfilBtn.addEventListener('click', function(ev) {
              if (window.innerWidth <= 760) {
                // evita que o dropdown padrão abra
                ev.preventDefault();
                ev.stopPropagation();
                try {
                  const myModalEl = document.getElementById('perfilModal');
                  if (myModalEl && window.bootstrap && bootstrap.Modal) {
                    const inst = bootstrap.Modal.getOrCreateInstance(myModalEl);
                    // atualizar conteúdo (por segurança)
                    const localUser = loadLocalUser();
                    if (localUser) updateHeaderUser(localUser);
                    inst.show();
                  }
                } catch (e) { console.warn('Erro ao abrir modal de perfil', e); }
              }
            });
          }
        } catch (e) { /* ignore */ }
      });

      function fallbackCopyText(text, anchor) {
        try {
          const ta = document.createElement('textarea');
          ta.value = text;
          ta.style.position = 'fixed'; ta.style.left='-9999px';
          document.body.appendChild(ta);
          ta.select();
          document.execCommand('copy');
          document.body.removeChild(ta);
          showCopyFeedback(anchor, 'E‑mail copiado');
        } catch (e) { alert('Copiar não disponível'); }
      }

      function showCopyFeedback(anchor, msg) {
        const fb = document.createElement('div');
        fb.className = 'copy-feedback';
        fb.textContent = msg;
        document.body.appendChild(fb);
        // after append, compute size and position
        const fbRect = fb.getBoundingClientRect();
        const rect = anchor.getBoundingClientRect();
        // center horizontally relative to anchor, but keep within viewport
        let left = rect.left + rect.width/2 - fbRect.width/2;
        left = Math.max(6, Math.min(left, window.innerWidth - fbRect.width - 6));
        let top = rect.top - fbRect.height - 8;
        if (top < 6) top = rect.bottom + 8; // if not enough space above, show below
        fb.style.left = left + 'px';
        fb.style.top = top + 'px';
        // Force reflow then show
        void fb.offsetWidth;
        fb.classList.add('show');
        setTimeout(() => { fb.classList.remove('show'); setTimeout(() => fb.remove(), 250); }, 1400);
      }

      // Animação: quando o dropdown do perfil abrir em mobile, adiciona classe slide-up
      document.addEventListener('DOMContentLoaded', function() {
        try {
          const perfilDropdown = document.getElementById('perfilDropdown');
          if (perfilDropdown) {
            perfilDropdown.addEventListener('shown.bs.dropdown', function(e) {
              const menu = perfilDropdown && perfilDropdown.parentElement ? perfilDropdown.parentElement.querySelector('.dropdown-menu') : null;
              if (!menu) return;
              if (window.innerWidth <= 760) {
                menu.classList.add('dropdown-slide-up');
              }
            });
            perfilDropdown.addEventListener('hidden.bs.dropdown', function(e) {
              const menu = perfilDropdown && perfilDropdown.parentElement ? perfilDropdown.parentElement.querySelector('.dropdown-menu') : null;
              if (!menu) return;
              menu.classList.remove('dropdown-slide-up');
            });
          }
        } catch (e) { /* ignore if bootstrap not present */ }
        // Quando o modal móvel abrir, ajustar foco para o primeiro elemento interativo
        try {
          const perfilModalEl = document.getElementById('perfilModal');
          if (perfilModalEl) {
            perfilModalEl.addEventListener('shown.bs.modal', function() {
              // foca o primeiro elemento interativo disponível no modal
              const first = perfilModalEl.querySelector('.modal-body a, .modal-body button, .modal-body input');
              if (first && typeof first.focus === 'function') {
                setTimeout(() => first.focus(), 120);
              }
            });
          }
        } catch (e) { /* ignore */ }
      });

      document.addEventListener('auth-changed', function(ev){
        try { updateHeaderUser(ev && ev.detail ? ev.detail : null); } catch(e){ console.warn('auth-changed handler error', e); }
      });
    })();
  </script>

  <div class="container my-4">
    <ul class="nav nav-pills justify-content-center mb-4">
      <li class="nav-item">
        <a class="nav-link active" data-bs-toggle="pill" href="#projeto">
          <i class="fas fa-info-circle me-2"></i>Sobre o Projeto
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" data-bs-toggle="pill" href="#mapa">
          <i class="fas fa-map me-2"></i>Mapa
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" data-bs-toggle="pill" href="#clima">
          <i class="fas fa-sun me-2"></i>Clima
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" data-bs-toggle="pill" href="#relatar" id="aba-relatar">
          <i class="fas fa-edit me-2"></i>Relatar
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" data-bs-toggle="pill" href="#sobre">
          <i class="fas fa-user me-2"></i>Sobre Nós
        </a>
      </li>
        <!-- nav-login-item removido (duplicado) para evitar botões repetidos no header -->
    </ul>

    <div class="tab-content">
      <!-- === Aba Projeto (principal) === -->
      <div class="tab-pane fade show active" id="projeto">
        <div class="main-card text-center animada">
          <h2 class="mb-3"><i class="fas fa-info-circle me-2"></i>Sobre o Projeto</h2>
          <p class="mb-3">O <strong>ClimaJá!</strong> é uma plataforma colaborativa para monitoramento meteorológico e relatos de alagamentos em tempo real. O objetivo é ajudar pessoas a se informarem sobre as condições do clima e compartilharem informações úteis para a sociedade, promovendo segurança e prevenção.</p>
          <p class="mb-3">Aqui você pode visualizar o mapa de alagamentos, consultar dados climáticos atualizados e relatar ocorrências de forma simples e rápida, contribuindo para uma cidade mais resiliente.</p>
        </div>
      </div>
      <!-- === Aba Sobre Nós === -->
      <div class="tab-pane fade" id="sobre">
        <div class="main-card text-center animada">
          <h2 class="mb-3"><i class="fas fa-user me-2"></i>Sobre Nós</h2>
          <img src="logo.png" alt="Avatar" style="width:80px;height:80px;border-radius:50%;box-shadow:0 2px 8px #2563eb22;margin-bottom:1rem;">
          <p class="mb-1">Olá! Nós somos da <strong>Escola Técnica Estadual Ginásio Pernambucano</strong>, uma equipe apaixonada por tecnologia, meteorologia e soluções inovadoras para a sociedade. O ClimaJá! foi criado para ajudar pessoas a monitorar o clima e compartilhar informações importantes sobre alagamentos em tempo real.</p>
          <!-- Ícones de email e LinkedIn removidos -->
          <p class="text-muted small">Entre em contato: <a href="mailto:oclimaja@hotmail.com">oclimaja@hotmail.com</a></p>
        </div>
      </div>
      <!-- === Aba Mapa === -->
      <div class="tab-pane fade" id="mapa">
        <div class="main-card animada">
          <div id="map" style="width:100%;height:450px;border-radius:1rem;"></div>
          <div class="mt-3 text-center">
            <button class="btn btn-modern" id="btn-localizacao">
              <i class="fas fa-location-crosshairs me-2"></i>Usar Minha Localização
            </button>
          </div>
        </div>
      </div>
      <!-- === Aba Clima === -->
      <div class="tab-pane fade" id="clima">
        <div class="main-card animada">
          <div id="clima-alerta-localizacao" style="display:none;" class="alert alert-warning text-center mt-2 mb-3">
            Para visualizar as informações do clima, permita o acesso à sua localização nas configurações do navegador.<br>
            Se já permitiu e não aparece, recarregue a página ou tente novamente mais tarde.
          </div>
          <!-- Fallback: buscar por cidade e tentar novamente -->
          <div id="clima-fallback" style="display:none;" class="text-center mt-2 mb-3">
            <div class="mb-2">Ou busque pelo nome da cidade:</div>
            <div class="d-flex justify-content-center gap-2">
              <input type="text" id="clima-cidade-input" class="form-control" placeholder="Ex: Recife, PE" style="max-width:320px;">
              <button id="clima-buscar-cidade" class="btn btn-modern">Buscar</button>
            </div>
            <div class="mt-2">
              <button id="clima-tentar-novamente" class="btn btn-link">Tentar novamente (localização)</button>
            </div>
          </div>
          <div class="weather-header">
            <i class="wi wi-day-sunny weather-icon"></i>
              <style>
                  .weather-header .weather-icon {
                 margin-left: 12px;
                 margin-top: 6px;
                 margin-right: 22px;
                 margin-bottom: 10px;
                 font-size: var(--weather-icon-size, 3.5rem);
                 transition: font-size 0.3s;
                  }
                  .weather-header .weather-icon.sunny { --weather-icon-size: 3.7rem; }
                  .weather-header .weather-icon.rain { --weather-icon-size: 4.2rem; }
                  .weather-header .weather-icon.cloud { --weather-icon-size: 3.2rem; }
                  .weather-header .weather-icon.storm { --weather-icon-size: 4.5rem; }
              </style>
              <div>
              <h2 class="mb-0" id="city-name">Carregando...</h2>
              <div class="sensor-value" id="current-temp">--°C</div>
            </div>
          </div>
          <div class="weather-grid">
            <div class="weather-item">
              <i class="wi wi-humidity"></i>
              <div class="mt-2">
                <div class="text-muted small">Umidade</div>
                <div class="fw-bold" id="humidity">--%</div>
              </div>
            </div>
            <div class="weather-item">
              <i class="wi wi-rain"></i>
              <div class="mt-2">
                <div class="text-muted small">Chuva</div>
                <div class="fw-bold" id="rain">--mm</div>
              </div>
            </div>
            <div class="weather-item">
              <i class="wi wi-strong-wind"></i>
              <div class="mt-2">
                <div class="text-muted small">Vento</div>
                <div class="fw-bold" id="wind-speed">--km/h</div>
              </div>
            </div>
            <div class="weather-item">
              <i class="wi wi-barometer"></i>
              <div class="mt-2">
                <div class="text-muted small">Pressão</div>
                <div class="fw-bold" id="pressure">--hPa</div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- === Aba Relatar === -->
      <div class="tab-pane fade" id="relatar">
        <div class="main-card animada" id="relato-area">
          <ul class="nav nav-tabs mb-3" id="tipoRelatoTabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="pedestre-tab" data-bs-toggle="tab" data-bs-target="#relato-pedestre" type="button" role="tab" aria-controls="relato-pedestre" aria-selected="true">Pedestre</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="motorista-tab" data-bs-toggle="tab" data-bs-target="#relato-motorista" type="button" role="tab" aria-controls="relato-motorista" aria-selected="false">Motorista</button>
            </li>
          </ul>
          <div class="tab-content">
            <div class="tab-pane fade show active" id="relato-pedestre" role="tabpanel" aria-labelledby="pedestre-tab">
              <form id="reportForm">
                <input type="hidden" id="latitude" name="latitude">
                <input type="hidden" id="longitude" name="longitude">
                <div class="mb-3">
                  <label for="address" class="form-label">Endereço do Ocorrido</label>
                  <div class="d-flex gap-2">
                    <input type="text" class="form-control" id="address" placeholder="Digite o endereço completo ou selecione no mapa" required autocomplete="off">
                    <button type="button" class="btn btn-outline-primary" id="use-my-location"><i class="fas fa-location-crosshairs"></i></button>
                  </div>
                  <div id="address-suggestions" class="dropdown-menu" style="width:100%"></div>
                  <small class="form-text text-muted">Exemplo: Rua Exemplo, 123, Bairro, Cidade</small>
                </div>
                <div class="mb-3">
                  <label for="ocorrido-primario" class="form-label">Ocorrido Primário</label>
                  <select class="form-select" id="ocorrido-primario" required>
                    <option value="">Selecione</option>
                    <option value="alagamento">💧 Alagamento</option>
                    <option value="enxurrada">🌊 Enxurrada</option>
                    <option value="obstrucao">🚧 Obstrução de via</option>
                    <option value="deslizamento">⛰️ Deslizamento</option>
                    <option value="fio-duvidoso">⚡ Fio duvidoso</option>
                    <option value="outro">❓ Outro</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label for="ocorrido-secundario" class="form-label">Ocorrido Secundário <span class="text-muted" style="font-weight:400;">(opcional)</span></label>
                  <select class="form-select" id="ocorrido-secundario">
                    <option value="">Nenhum</option>
                    <option value="alagamento">💧 Alagamento</option>
                    <option value="enxurrada">🌊 Enxurrada</option>
                    <option value="obstrucao">🚧 Obstrução de via</option>
                    <option value="deslizamento">⛰️ Deslizamento</option>
                    <option value="fio-duvidoso">⚡ Fio duvidoso</option>
                    <option value="outro">❓ Outro</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label for="water-level" class="form-label">Nível da Água</label>
                  <select class="form-select" id="water-level" required>
                    <option value="">Selecione</option>
                    <option value="0">Sem água no momento</option>
                    <option value="0.2">Até o tornozelo (baixo)</option>
                    <option value="0.5">Até o joelho (moderado)</option>
                    <option value="1.0">Até a cintura (alto)</option>
                    <option value="1.5">Acima da cintura (grave)</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label for="descricao" class="form-label">Descrição detalhada <span class="text-muted" style="font-weight:400;">(opcional)</span></label>
                  <textarea class="form-control" id="descricao" rows="3" placeholder="Descreva o que aconteceu, pontos de referência, impactos, etc."></textarea>
                  <small class="form-text text-muted">Inclua detalhes como horário, danos, pessoas afetadas, etc.</small>
                </div>
                <div class="mb-3">
              <!-- Data e hora removidos, são automáticos -->
                </div>
                <div class="mb-3">
                  <label for="flood-photo" class="form-label">Fotos (opcional, até 3)</label>
                  <input type="file" class="form-control" id="flood-photo" accept="image/*" multiple>
                  <small class="form-text text-muted">Você pode anexar até 3 fotos do local.</small>
                </div>
                <button type="submit" class="btn btn-modern">Enviar Relato</button>
              </form>
            </div>
            <div class="tab-pane fade" id="relato-motorista" role="tabpanel" aria-labelledby="motorista-tab">
              <form id="reportFormMotorista">
                <input type="hidden" id="latitude-motorista" name="latitude">
                <input type="hidden" id="longitude-motorista" name="longitude">
                <div class="mb-3">
                  <label for="address-motorista" class="form-label">Endereço do Ocorrido</label>
                  <div class="d-flex gap-2">
                    <input type="text" class="form-control" id="address-motorista" placeholder="Digite o endereço completo ou selecione no mapa" required autocomplete="off">
                    <button type="button" class="btn btn-outline-primary" id="use-my-location-motorista"><i class="fas fa-location-crosshairs"></i></button>
                  </div>
                  <div id="address-suggestions-motorista" class="dropdown-menu" style="width:100%"></div>
                  <small class="form-text text-muted">Exemplo: Rua Exemplo, 123, Bairro, Cidade</small>
                </div>
                  <div class="mb-3">
                    <label for="ocorrido-primario-motorista" class="form-label">Ocorrido Principal</label>
                    <select class="form-select" id="ocorrido-primario-motorista" name="ocorridoPrimarioMotorista" required>
                      <option value="">Selecione</option>
                      <option value="alagamento">💧 Alagamento</option>
                      <option value="enxurrada">🌊 Enxurrada</option>
                      <option value="obstrucao">🚧 Obstrução de via</option>
                      <option value="deslizamento">⛰️ Deslizamento</option>
                      <option value="fio-duvidoso">⚡ Fio duvidoso</option>
                      <option value="outro">❓ Outro</option>
                    </select>
                  </div>
                  <div class="mb-3">
                    <label for="ocorrido-secundario-motorista" class="form-label">Ocorrido Secundário <span class="text-muted" style="font-weight:400;">(opcional)</span></label>
                    <select class="form-select" id="ocorrido-secundario-motorista" name="ocorridoSecundarioMotorista">
                      <option value="">Nenhum</option>
                      <option value="alagamento">💧 Alagamento</option>
                      <option value="enxurrada">🌊 Enxurrada</option>
                      <option value="obstrucao">🚧 Obstrução de via</option>
                      <option value="deslizamento">⛰️ Deslizamento</option>
                      <option value="fio-duvidoso">⚡ Fio duvidoso</option>
                      <option value="outro">❓ Outro</option>
                    </select>
                  </div>
                <div class="mb-3">
                  <label for="veiculo" class="form-label">Veículo</label>
                  <input type="text" class="form-control" id="veiculo" placeholder="Marca e modelo do veículo" required>
                </div>
                <div class="mb-3">
                  <label for="nivel-submersao" class="form-label">Nível de Submersão</label>
                  <select class="form-select" id="nivel-submersao" required>
                    <option value="">Selecione</option>
                    <option value="0">Sem água no momento</option>
                    <option value="0.2">Até a metade da roda</option>
                    <option value="0.5">Até a porta</option>
                    <option value="1.0">Acima da porta</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label for="descricao-motorista" class="form-label">Descrição detalhada <span class="text-muted" style="font-weight:400;">(opcional)</span></label>
                  <textarea class="form-control" id="descricao-motorista" rows="3" placeholder="Descreva o que aconteceu, pontos de referência, impactos, etc."></textarea>
                  <small class="form-text text-muted">Inclua detalhes como horário, danos, pessoas afetadas, etc.</small>
                </div>
                <div class="mb-3">
              <!-- Data e hora removidos, são automáticos -->
                </div>
                <div class="mb-3">
                  <label for="flood-photo-motorista" class="form-label">Fotos (opcional, até 3)</label>
                  <input type="file" class="form-control" id="flood-photo-motorista" accept="image/*" multiple>
                  <small class="form-text text-muted">Você pode anexar até 3 fotos do local.</small>
                </div>
                <button type="submit" class="btn btn-modern">Enviar Relato</button>
              </form>
            </div>
          </div>
        </div>
        <div id="relato-login-msg" class="text-center my-3 d-none">
          <div class="alert alert-warning d-inline-block px-4 py-2" style="font-size:1.1rem;">
            <i class="fas fa-lock me-2"></i>Você precisa estar logado para enviar um relato.<br>
          </div>
        </div>
        <div id="relatos-publicos" class="mt-4">
          <!-- Relatos públicos serão exibidos aqui via JS -->
        </div>
      </div>
    

  <footer class="bg-light py-4 mt-5 border-top" style="transition:background 0.3s;">
    <div class="container text-center">
      <h5 class="mb-2"><i class="fas fa-cloud-sun me-2"></i>ClimaJá! &copy; 2025</h5>
      <p class="mb-1">Projeto de monitoramento meteorológico e relatos de alagamentos. Desenvolvido por Escola Técnica Estadual Ginásio Pernambucano.</p>
      <div class="mb-2">
        <!-- Removido: links github, linkedin, twitter -->
      </div>
      <div class="d-flex justify-content-center align-items-center gap-4 my-3">
        <img src="cria.png" alt="Logo CRIA" class="footer-logo-img" loading="lazy">
        <img src="clube.png" alt="Logo Clube" class="footer-logo-img" loading="lazy">
      </div>
      <p class="text-muted small">Entre em contato: <a href="mailto:oclimaja@hotmail.com">oclimaja@hotmail.com</a></p>
    </div>
  </footer>

  <!-- Modal mobile-friendly para perfil (usado em telas pequenas) -->
  <div class="modal fade" id="perfilModal" tabindex="-1" aria-labelledby="perfilModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-sm modal-mobile" role="dialog" aria-modal="true">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="perfilModalLabel">Meu Perfil</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
          <div id="modal-perfil-dados" style="display:flex;gap:12px;align-items:center;">
            <img src="logo.png" alt="Avatar" style="width:72px;height:72px;border-radius:50%;box-shadow:0 2px 8px #2563eb22;margin:0;">
            <div style="flex:1;min-width:0;">
              <div id="modal-perfil-nome" style="font-weight:800;color:#2563eb;margin-bottom:4px;word-break:break-word;">-</div>
              <div style="display:flex;gap:8px;align-items:center;">
                <div id="modal-perfil-email" style="color:#3a506b;font-weight:600;word-break:break-word;">-</div>
              </div>
            </div>
          </div>
          <div class="mt-3 d-grid gap-2">
            <a class="btn btn-primary" href="profile.html">Acessar Perfil</a>
            <button class="btn btn-outline-primary" id="modal-meus-relatos">Meus Relatos</button>
            <button class="btn btn-outline-info" id="modal-ajuda">Ajuda</button>
            <button class="btn btn-danger" id="modal-logout-btn">Sair</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <style>
    /* Modal mobile fullscreen below 760px */
    @media (max-width: 760px) {
      .modal-mobile .modal-dialog {
        width: 100% !important;
        height: 100% !important;
        margin: 0 !important;
        max-width: none !important;
        display: flex;
        align-items: stretch;
      }
      .modal-mobile .modal-content {
        border-radius: 1rem 1rem 0 0 !important;
        height: 100vh;
        overflow: auto;
      }
      .modal-mobile .modal-body { padding-bottom: 1.5rem; }
      .modal-mobile .modal-header { border-bottom: 1px solid #eee; }
    }
  </style>
  <style>
    /* Melhor quebra de linha para e-mail e nomes no header/modal */
    .perfil-email-row #perfil-email,
    #modal-perfil-email,
    #perfil-nome,
    #perfil-nome-area {
      max-width: 200px;
      overflow-wrap: anywhere;
      word-break: break-word;
      text-align: center;
    }
    @media (max-width:420px) {
      .perfil-email-row #perfil-email,
      #modal-perfil-email,
      #perfil-nome-area { font-size: 0.92rem; max-width: 150px; }
    }
  </style>

  <!-- JS externos -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="./paranoid-security.js"></script>
  <!-- Nosso JS -->
  <script type="module" src="script.js"></script>
  <!-- Firebase SDK -->
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
  <script>
    // Delegadores leves: chamam as funções expostas pelo script.js (evita duplicidade)
    function inicializarMapaLeaflet() {
      if (window.inicializarMapaLeaflet) return window.inicializarMapaLeaflet();
      // fallback: tenta chamar initMap diretamente
      if (window.initMap) return window.initMap();
    }

    function pedirLocalizacaoMapa() {
      if (window.pedirLocalizacaoMapa) return window.pedirLocalizacaoMapa();
      if (window.locateUser) return window.locateUser(true);
    }

    document.addEventListener('DOMContentLoaded', function() {
      // Inicializa mapa ao abrir aba, delegando para o script.js
      document.querySelectorAll('a[data-bs-toggle="pill"]').forEach(function(tab) {
        tab.addEventListener('shown.bs.tab', function (e) {
          if (e.target.getAttribute('href') === '#mapa') {
            inicializarMapaLeaflet();
            pedirLocalizacaoMapa();
          }
        });
      });
      // Botão de localização
      var btnLoc = document.getElementById('btn-localizacao');
      if (btnLoc) btnLoc.onclick = pedirLocalizacaoMapa;

      // Photon autocomplete para campo de endereço
      function setupPhotonAutocomplete(inputId, latId, lonId, suggestionsId) {
        var input = document.getElementById(inputId);
        var suggestions = document.getElementById(suggestionsId);
        input.addEventListener('input', function() {
          var query = input.value;
          if (query.length < 3) {
            suggestions.style.display = 'none';
            return;
          }
          fetch('https://photon.komoot.io/api/?q=' + encodeURIComponent(query) + '&limit=5')
            .then(res => res.json())
            .then(data => {
              suggestions.innerHTML = '';
              data.features.forEach(function(feature) {
                var item = document.createElement('button');
                item.type = 'button';
                item.className = 'dropdown-item';
                item.textContent = feature.properties.name + (feature.properties.city ? ', ' + feature.properties.city : '');
                item.onclick = function() {
                  input.value = item.textContent;
                  document.getElementById(latId).value = feature.geometry.coordinates[1];
                  document.getElementById(lonId).value = feature.geometry.coordinates[0];
                    if (window.meuMapa) {
                      window.meuMapa.setView([feature.geometry.coordinates[1], feature.geometry.coordinates[0]], 16);
                      // Marcador sem popup (solicitação: remover pop-ups, manter apenas avisos do site)
                      L.marker([feature.geometry.coordinates[1], feature.geometry.coordinates[0]]).addTo(window.meuMapa);
                    }
                  suggestions.style.display = 'none';
                };
                suggestions.appendChild(item);
              });
              suggestions.style.display = data.features.length ? 'block' : 'none';
            });
        });
        input.addEventListener('blur', function() {
          setTimeout(() => suggestions.style.display = 'none', 200);
        });
      }

      // Ativa autocomplete Photon nos campos de endereço
      setupPhotonAutocomplete('address', 'latitude', 'longitude', 'address-suggestions');
      setupPhotonAutocomplete('address-motorista', 'latitude-motorista', 'longitude-motorista', 'address-suggestions-motorista');
    });
  </script>
<!-- Firebase removido temporariamente -->
  <script>
    // Firebase removido temporariamente
    // ...código anterior...
    // Funções de clima e mapa permanecem iguais
    // Localização global do usuário
    let userLocation = null;

    // Solicita localização ao abrir o site e atualiza Windy
    function pedirLocalizacaoInicial() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(pos) {
          userLocation = {
            lat: pos.coords.latitude,
            lon: pos.coords.longitude
          };
          atualizarClimaComLocalizacao();
          atualizarMapaWindy();
        }, function(err) {
          userLocation = null;
          alert('Não foi possível obter sua localização exata. Algumas funções podem ficar limitadas.');
        }, {enableHighAccuracy:true, timeout:10000});
      } else {
        alert('Seu navegador não suporta geolocalização.');
      }
    }

    // Atualiza o iframe do Windy para a localização do usuário
    function atualizarMapaWindy() {
      if (!userLocation) return;
      var windyFrame = document.getElementById('windy-embed');
      if (windyFrame) {
        windyFrame.src = `https://embed.windy.com/embed2.html?lat=${userLocation.lat}&lon=${userLocation.lon}&detailLat=${userLocation.lat}&detailLon=${userLocation.lon}&width=650&height=450&zoom=13&level=surface&overlay=rain&product=ecmwf`;
      }
    }

    // Botão manual para atualizar Windy
    function pedirLocalizacaoWindy() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(pos) {
          userLocation = {
            lat: pos.coords.latitude,
            lon: pos.coords.longitude
          };
          atualizarMapaWindy();
        }, function() {
          alert('Não foi possível obter sua localização.');
        }, {enableHighAccuracy:true, timeout:10000});
      } else {
        alert('Seu navegador não suporta geolocalização.');
      }
    }

    // Atualiza aba Clima com localização
    function atualizarClimaComLocalizacao() {
      const alerta = document.getElementById('clima-alerta-localizacao');
      if (!userLocation) {
        if (alerta) alerta.style.display = '';
        // Limpa dados
        document.getElementById('current-temp').textContent = '--°C';
        document.getElementById('city-name').textContent = '--';
        document.getElementById('humidity').textContent = '--%';
        document.getElementById('wind-speed').textContent = '--km/h';
        document.getElementById('pressure').textContent = '--';
        document.getElementById('rain').textContent = '--mm';
        return;
      }

      // Buscar bairro/cidade via Nominatim (não crítico)
      fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${userLocation.lat}&lon=${userLocation.lon}&addressdetails=1`)
        .then(res => res.json())
        .then(addrData => {
          let bairro = '';
          let cidade = '';
          if (addrData && addrData.address) {
            const a = addrData.address;
            bairro = a.suburb || a.neighbourhood || a.village || a.town || '';
            cidade = a.city || a.town || a.village || a.county || a.state || '';
          }

          // Buscar clima: inclui hourly para obter umidade/precipitação/pressão no mesmo timestamp do current_weather
          const url = `https://api.open-meteo.com/v1/forecast?latitude=${userLocation.lat}&longitude=${userLocation.lon}&current_weather=true&hourly=relativehumidity_2m,precipitation,pressure_msl&timezone=auto`;
          return fetch(url)
            .then(res => res.json())
            .then(data => ({ data, bairro, cidade }));
        })
        .then(({ data, bairro, cidade }) => {
          try {
            if (!data || !data.current_weather) {
              if (alerta) alerta.style.display = '';
              return;
            }

            const cw = data.current_weather;
            const tempEl = document.getElementById('current-temp');
            const cityEl = document.getElementById('city-name');
            const humEl = document.getElementById('humidity');
            const windEl = document.getElementById('wind-speed');
            const presEl = document.getElementById('pressure');
            const rainEl = document.getElementById('rain');

            if (tempEl) tempEl.textContent = `${cw.temperature}°C`;
            // Iniciar alternância entre bairro e cidade (cidade pode ficar vazia)
            if (cityEl) {
              // se bairro vazio usa cidade; se ambos vazios usa 'Localização'
              const fallback = cidade || bairro || 'Localização';
              cityEl.textContent = bairro || fallback;
              // iniciar alternância
              startCidadeBairroToggle(cidade, bairro);
            }
            if (windEl) windEl.textContent = `${cw.windspeed} km/h`;

            // Atualiza ícone com base no weathercode do Open-Meteo (WMO codes)
            try {
              const iconEl = document.querySelector('.weather-icon');
              if (iconEl && cw.weathercode != null) {
                const code = Number(cw.weathercode);
                let wiClass = 'wi-day-sunny';
                let semantic = 'sunny';
                if (code === 0) { wiClass = 'wi-day-sunny'; semantic = 'sunny'; }
                else if (code >= 1 && code <= 3) { wiClass = 'wi-day-cloudy'; semantic = 'cloud'; }
                else if (code === 45 || code === 48) { wiClass = 'wi-fog'; semantic = 'cloud'; }
                else if ((code >= 51 && code <= 67) || (code >= 80 && code <= 82)) { wiClass = 'wi-rain'; semantic = 'rain'; }
                else if (code >= 95) { wiClass = 'wi-thunderstorm'; semantic = 'storm'; }
                else { wiClass = 'wi-day-sunny'; semantic = 'sunny'; }
                iconEl.className = `wi ${wiClass} weather-icon`;
                iconEl.classList.remove('sunny','rain','cloud','storm');
                iconEl.classList.add(semantic);
              }
            } catch (e) { console.warn('Não foi possível atualizar ícone do clima:', e); }

            // tenta extrair umidade/precipitação/pressão a partir de hourly no mesmo timestamp do current_weather
            let humidity = '--%';
            let precipitation = '--mm';
            let pressure = '--';
            if (data.hourly && Array.isArray(data.hourly.time)) {
              let idx = data.hourly.time.indexOf(cw.time);
              // se não encontrou correspondência exata, procura o índice com timestamp mais próximo
              if (idx === -1) {
                try {
                  const times = data.hourly.time.map(t => Date.parse(t));
                  const target = cw.time ? Date.parse(cw.time) : Date.now();
                  let best = -1;
                  let bestDiff = Infinity;
                  for (let i = 0; i < times.length; i++) {
                    const d = Math.abs(times[i] - target);
                    if (d < bestDiff) { bestDiff = d; best = i; }
                  }
                  if (best !== -1) idx = best;
                } catch (e) {
                  // falha ao parsear datas — deixa idx como -1 e usa valores default
                  console.warn('Não foi possível casar timestamps do hourly com current_weather:', e);
                }
              }
              if (idx !== -1) {
                if (data.hourly.relativehumidity_2m && data.hourly.relativehumidity_2m[idx] != null) humidity = `${data.hourly.relativehumidity_2m[idx]}%`;
                if (data.hourly.precipitation && data.hourly.precipitation[idx] != null) precipitation = `${data.hourly.precipitation[idx]} mm`;
                if (data.hourly.pressure_msl && data.hourly.pressure_msl[idx] != null) pressure = `${data.hourly.pressure_msl[idx]} hPa`;
              }
            }

            // Debug: logar informações importantes para investigação
            try {
              console.debug('Open-Meteo response keys:', Object.keys(data || {}));
              if (data && data.hourly) {
                console.debug('hourly keys:', Object.keys(data.hourly));
                console.debug('hourly.time length:', data.hourly.time ? data.hourly.time.length : 0);
              }
              console.debug('current_weather.time:', cw.time, 'matched idx:', typeof idx !== 'undefined' ? idx : 'n/a');
              if (data && data.hourly && data.hourly.precipitation) {
                // se toda a série de precipitação for zeros, apresentar 0 mm
                const allZero = data.hourly.precipitation.every(v => v === 0);
                if (allZero) precipitation = '0 mm';
                console.debug('sample precipitation values (first 10):', data.hourly.precipitation.slice(0,10));
              }
            } catch (e) {
              console.debug('Erro ao logar debug de clima:', e);
            }

            if (humEl) humEl.textContent = humidity;
            if (rainEl) rainEl.textContent = precipitation;
            if (presEl) presEl.textContent = pressure;

            if (alerta) alerta.style.display = 'none';
          } catch (err) {
            console.error('Erro processando dados de clima:', err);
            if (alerta) alerta.style.display = '';
          }
        })
        .catch(err => {
          console.error('Erro ao buscar clima ou localização:', err);
          if (alerta) alerta.style.display = '';
        });
    }

    // Centraliza o mapa na localização do usuário
    function centralizarMapaNaLocalizacao() {
      if (!userLocation || !window.meuMapa) return;
      window.meuMapa.setView([userLocation.lat, userLocation.lon], 15);
      if (!window.userMarker) {
        window.userMarker = L.marker([userLocation.lat, userLocation.lon], {icon: L.icon({iconUrl: 'user-marker.png', iconSize: [32,32]})}).addTo(window.meuMapa);
      } else {
        window.userMarker.setLatLng([userLocation.lat, userLocation.lon]);
      }
    }

    // Alterna o conteúdo do elemento #city-name entre cidade e bairro a cada 5 segundos
    function startCidadeBairroToggle(cidade, bairro) {
      try {
        // limpa intervalo anterior, se houver
        if (window._toggleCidadeBairroInterval) {
          clearInterval(window._toggleCidadeBairroInterval);
          window._toggleCidadeBairroInterval = null;
        }
        const el = document.getElementById('city-name');
        if (!el) return;
        // Normaliza valores
        const cidadeNorm = (cidade && String(cidade).trim()) || '';
        const bairroNorm = (bairro && String(bairro).trim()) || '';
        // Se ambos vazios, mostra Localização e não inicia alternância
        if (!cidadeNorm && !bairroNorm) {
          el.textContent = 'Localização';
          return;
        }
        // Estado interno
        let showBairro = true;
  // Inicial
  el.textContent = bairroNorm || cidadeNorm || 'Localização';
  // garante estado sem classe de troca
  el.classList.remove('city-switching');
        // Se não há bairro ou cidade, talvez não precise alternar
        if (!cidadeNorm || !bairroNorm) return;
        // Cria intervalo
        window._toggleCidadeBairroInterval = setInterval(() => {
          showBairro = !showBairro;
          const newText = showBairro ? (bairroNorm || cidadeNorm) : (cidadeNorm || bairroNorm);
          // animação: fade out -> trocar texto -> fade in
          try {
            // usa classe para animar (fade-out + slide), depois troca o texto e remove a classe (fade-in)
            el.classList.add('city-switching');
            setTimeout(() => {
              el.textContent = newText;
              // remove a classe para acionar fade-in
              el.classList.remove('city-switching');
            }, 380);
          } catch (e) {
            el.textContent = newText;
          }
        }, 5000);
      } catch (e) {
        console.warn('Erro ao iniciar alternância cidade/bairro:', e);
      }
    }

    // Limpa intervalo ao descarregar a página
    window.addEventListener('beforeunload', function() {
      if (window._toggleCidadeBairroInterval) clearInterval(window._toggleCidadeBairroInterval);
    });

    // Função para localizar usuário via botão no mapa
    function locateUser(btn) {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(pos) {
          userLocation = {
            lat: pos.coords.latitude,
            lon: pos.coords.longitude
          };
          centralizarMapaNaLocalizacao();
        });
      }
    }

    // Função para preencher o campo de endereço com a localização atual ao abrir a aba Relatar
    function preencherEnderecoAtual() {
      const addressInput = document.getElementById('address');
      const latInput = document.getElementById('latitude');
      const lonInput = document.getElementById('longitude');
      if (!addressInput) return;
      if (userLocation) {
        latInput.value = userLocation.lat;
        lonInput.value = userLocation.lon;
        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${userLocation.lat}&lon=${userLocation.lon}&addressdetails=1`)
          .then(res => res.json())
          .then(data => {
            if (data && data.display_name) {
              addressInput.value = data.display_name;
            }
          });
      } else if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(pos) {
          latInput.value = pos.coords.latitude;
          lonInput.value = pos.coords.longitude;
          fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${pos.coords.latitude}&lon=${pos.coords.longitude}&addressdetails=1`)
            .then(res => res.json())
            .then(data => {
              if (data && data.display_name) {
                addressInput.value = data.display_name;
              }
            });
        });
      }
    }

    // preencherEnderecoAtual já definido acima — removida definição duplicada

    document.addEventListener('DOMContentLoaded', function() {
      // Solicita localização ao abrir o site
      pedirLocalizacaoInicial();

      // Preencher automaticamente ao abrir aba Relatar
      document.querySelectorAll('a[data-bs-toggle="pill"]').forEach(function(tab) {
        tab.addEventListener('shown.bs.tab', function (e) {
          if (e.target.getAttribute('href') === '#relatar') {
            preencherEnderecoAtual();
          }
          if (e.target.getAttribute('href') === '#clima') {
            atualizarClimaComLocalizacao();
              // ícone do clima será atualizado dentro de atualizarClimaComLocalizacao() usando o weathercode do Open-Meteo
          }
          if (e.target.getAttribute('href') === '#mapa') {
            // Delega para script.js (evita múltiplas inicializações)
            if (window.inicializarMapaLeaflet) window.inicializarMapaLeaflet();
            if (window.centralizarMapaNaLocalizacao) window.centralizarMapaNaLocalizacao();
            else if (window.centralizarMapaNaLocalizacao) window.centralizarMapaNaLocalizacao();
          }
        });
      });

      // Delegador para inicializar o mapa (implementação real em script.js)
      function inicializarMapaLeaflet() {
        if (window.inicializarMapaLeaflet) return window.inicializarMapaLeaflet();
        if (window.initMap) return window.initMap();
      }
      // Relatos locais (em memória) - agora global
      // ...existing code...

const reportForm = document.getElementById('reportForm');
if (reportForm) {
  reportForm.addEventListener('submit', async function(e) {
    e.preventDefault();
    // Coleta os dados do formulário
    const latitude = document.getElementById('latitude').value;
    const longitude = document.getElementById('longitude').value;
    const address = document.getElementById('address').value;
    const ocorridoPrimario = document.getElementById('ocorrido-primario').value;
    const ocorridoSecundario = document.getElementById('ocorrido-secundario').value;
    const nivel = document.getElementById('water-level').value;
    const descricao = document.getElementById('descricao').value;
    let fotos = [];
    const photoInput = document.getElementById('flood-photo');
    if (photoInput && photoInput.files.length > 0) {
      for (let i = 0; i < Math.min(photoInput.files.length, 3); i++) {
        fotos.push(photoInput.files[i].name); // ou faça upload e salve o link
      }
    }

    const relato = {
      latitude,
      longitude,
      address,
      ocorridoPrimario,
      ocorridoSecundario,
      nivel,
      descricao,
      fotos,
      status: 'publico',
      uid: auth.currentUser ? auth.currentUser.uid : null
    };

    const ok = await salvarRelatoFirestore(relato);
    if (ok) {
      alert('Relato enviado com sucesso!');
      reportForm.reset();
      fecharSelecaoLocalizacao();
      // Se quiser, chame aqui a função para atualizar a lista de relatos
      // carregarRelatosPublicos();
    } else {
      alert('Erro ao salvar relato no banco de dados!');
    }
  });
}
      // Exibe relatos locais ao carregar
      carregarRelatosPublicos();
    });

    // Função para carregar relatos públicos
// ...existing code...
// Delegação para carregar relatos — o script principal (`script.js`) expõe `window.carregarRelatosPublicos`.
function carregarRelatosPublicos() {
  if (window.carregarRelatosPublicos) return window.carregarRelatosPublicos();
  // fallback: nada (não usamos localStorage para relatos)
  console.warn('carregarRelatosPublicos não implementado no ambiente atual.');
}
  </script>
  <script>
  // Força updateAuthUI após login
  document.addEventListener('DOMContentLoaded', function() {
    if (window.auth && window.firebase && window.firebase.auth) {
      window.firebase.auth().onAuthStateChanged(function(user) {
        // updateAuthUI(user); // Removido, controle feito pelo script.js
      });
    } else if (window.auth && window.onAuthStateChanged) {
      window.onAuthStateChanged(window.auth, function(user) {
        // updateAuthUI(user); // Removido, controle feito pelo script.js
      });
    } else {
      // Controle de autenticação feito pelo script.js
    }
  });
</script>
<!-- Ajuste: inverter posição do botão 'Baixar APP' e o 'perfil' quando o usuário estiver logado -->
<script>
  (function() {
    const baixarId = 'baixar-app-btn';
    const perfilId = 'perfil-area';

    function swapIfLogged() {
      const baixar = document.getElementById(baixarId);
      const perfil = document.getElementById(perfilId);
      if (!baixar || !perfil) return;
      // Se perfil visível (não tem classe d-none), invertemos a ordem para "baixar" antes de "perfil"
      const isVisible = !perfil.classList.contains('d-none');
      const parent = perfil.parentNode;
      if (isVisible) {
        // Se já estiver na ordem desejada (baixar antes de perfil), não faz nada
        if (parent && parent.firstElementChild === baixar) return;
        try {
          parent.insertBefore(baixar, perfil);
        } catch (e) { console.warn('Erro ao mover botões:', e); }
      } else {
        // Quando não logado, restaurar ordem original: perfil (oculto) antes de baixar
        try {
          parent.insertBefore(perfil, baixar);
        } catch (e) { /* ignore */ }
      }
    }

    // Observe mudanças na classe do elemento de perfil para detectar login/logout
    document.addEventListener('DOMContentLoaded', function() {
      const perfil = document.getElementById(perfilId);
      if (!perfil) return;
      const obs = new MutationObserver(() => swapIfLogged());
      obs.observe(perfil, { attributes: true, attributeFilter: ['class'] });
      // Chamada inicial (caso já esteja logado)
      setTimeout(swapIfLogged, 300);
      // também tenta novamente depois de 1500ms (em caso de scripts externos trocarem a ordem depois)
      setTimeout(swapIfLogged, 1500);
    });
  })();
</script>
</body>
</html>
