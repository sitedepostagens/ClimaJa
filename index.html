<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClimaJ√°! - Monitoramento Meteorol√≥gico</title>
    <link rel="icon" type="image/png" href="logo.png">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/weather-icons/2.0.12/css/weather-icons.min.css">

    <style>
        :root {
            --primary: #2563EB;
            --secondary: #1D4ED8;
            --background: #f8fafc;
            --text: #1e293b;
            --card-bg: #ffffff;
            --border: #e2e8f0;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        [data-theme="dark"] {
            --primary: #60a5fa;
            --secondary: #3b82f6;
            --background: #0f172a;
            --text: #f8fafc;
            --card-bg: #1e293b;
            --border: #334155;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
        }

        body {
            font-family: 'Inter', system-ui, sans-serif;
            background-color: var(--background);
            color: var(--text);
            transition: all 0.3s ease;
        }

        .navbar {
            box-shadow: var(--shadow);
        }

        .main-card {
            background: var(--card-bg);
            border-radius: 1rem;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        #map {
            height: 60vh;
            border-radius: 0.75rem;
            border: 1px solid var(--border);
        }

        .weather-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .weather-icon {
            font-size: 3rem;
            color: var(--primary);
        }

        .sensor-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .weather-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
        }

        .weather-item {
            padding: 1rem;
            border-radius: 0.5rem;
            background: var(--card-bg);
            border: 1px solid var(--border);
            text-align: center;
        }

        .theme-switcher {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--card-bg);
            border: 1px solid var(--border);
            cursor: pointer;
            display: grid;
            place-items: center;
            box-shadow: var(--shadow);
            z-index: 1000;
        }

        .report-marker {
            background: #dc2626;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .form-control {
            background: var(--card-bg);
            border: 1px solid var(--border);
            color: var(--text);
        }

        .nav-pills .nav-link {
            background: var(--card-bg);
            color: var(--text);
            border: 1px solid var(--border);
        }

        .nav-pills .nav-link.active {
            background: var(--primary) !important;
            border-color: var(--primary);
        }
    </style>
</head>
<body>
    <div class="theme-switcher" onclick="toggleTheme()">
        <i class="fas fa-moon"></i>
    </div>

    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="#">
                <img src="logo.png" alt="ClimaJ√°!" class="me-2" style="height: 40px;">
                ClimaJ√°!
            </a>
        </div>
    </nav>

    <div class="container my-4">
        <ul class="nav nav-pills justify-content-center mb-4">
            <li class="nav-item">
                <a class="nav-link active" data-bs-toggle="pill" href="#mapa">
                    <i class="fas fa-map me-2"></i>Mapa
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="pill" href="#clima">
                    <i class="fas fa-sun me-2"></i>Clima
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="pill" href="#relatar">
                    <i class="fas fa-edit me-2"></i>Relatar
                </a>
            </li>
        </ul>

        <div class="tab-content">
            <!-- Mapa -->
            <div class="tab-pane fade show active" id="mapa">
                <div class="main-card">
                    <div id="map"></div>
                    <div class="mt-3 text-center">
                        <button class="btn btn-primary" onclick="locateUser(true)">
                            <i class="fas fa-location-crosshairs me-2"></i>Minha Localiza√ß√£o
                        </button>
                    </div>
                </div>
            </div>

            <!-- Clima -->
            <div class="tab-pane fade" id="clima">
                <div class="main-card">
                    <div class="weather-header">
                        <i class="wi wi-day-sunny weather-icon"></i>
                        <div>
                            <h2 class="mb-0" id="city-name">Carregando...</h2>
                            <div class="sensor-value" id="current-temp">--¬∞C</div>
                        </div>
                    </div>
                    
                    <div class="weather-grid">
                        <div class="weather-item">
                            <i class="wi wi-humidity"></i>
                            <div class="mt-2">
                                <div class="text-muted small">Umidade</div>
                                <div class="fw-bold" id="humidity">--%</div>
                            </div>
                        </div>
                        <div class="weather-item">
                            <i class="wi wi-rain"></i>
                            <div class="mt-2">
                                <div class="text-muted small">Chuva</div>
                                <div class="fw-bold" id="rain">--mm</div>
                            </div>
                        </div>
                        <div class="weather-item">
                            <i class="wi wi-strong-wind"></i>
                            <div class="mt-2">
                                <div class="text-muted small">Vento</div>
                                <div class="fw-bold" id="wind-speed">--km/h</div>
                            </div>
                        </div>
                        <div class="weather-item">
                            <i class="wi wi-barometer"></i>
                            <div class="mt-2">
                                <div class="text-muted small">Press√£o</div>
                                <div class="fw-bold" id="pressure">--hPa</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Relatar -->
            <div class="tab-pane fade" id="relatar">
                <div class="main-card">
                    <h4 class="mb-4"><i class="fas fa-plus-circle me-2"></i>Novo Relato</h4>
                    <form id="reportForm">
                        <div class="mb-3">
                            <label class="form-label">Tipo de Relato</label>
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-outline-primary active" onclick="toggleReportType('pedestre')">
                                    <i class="fas fa-person-walking me-2"></i>Pedestre
                                </button>
                                <button type="button" class="btn btn-outline-primary" onclick="toggleReportType('motorista')">
                                    <i class="fas fa-car-side me-2"></i>Motorista
                                </button>
                            </div>
                        </div>

                        <div id="pedestre-form">
                            <div class="mb-3">
                                <label class="form-label">N√≠vel da √Ågua</label>
                                <select class="form-select" id="water-level">
                                    <option value="0.2">Tornozelo (0-0.2m)</option>
                                    <option value="0.5">Panturrilha (0.2-0.5m)</option>
                                    <option value="1.0">Joelho (0.5-1.0m)</option>
                                    <option value="1.5">Cintura (1.0-1.5m)</option>
                                    <option value="2.0">Peito (+1.5m)</option>
                                </select>
                            </div>
                        </div>

                        <div id="motorista-form" class="d-none">
                            <div class="mb-3">
                                <label class="form-label">Modelo do Ve√≠culo</label>
                                <input type="text" class="form-control" id="vehicle-model" placeholder="Ex: Fiat Uno 1.0">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">N√≠vel de Submers√£o</label>
                                <select class="form-select" id="car-water-level">
                                    <option value="25">Rodas (25%)</option>
                                    <option value="50">Portas (50%)</option>
                                    <option value="75">Cap√¥ (75%)</option>
                                    <option value="100">Totalmente Submerso</option>
                                </select>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label"><i class="fas fa-map-marker-alt me-2"></i>Localiza√ß√£o</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="address" placeholder="Digite um endere√ßo" required>
                                <button class="btn btn-outline-secondary" type="button" onclick="searchLocation()">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="form-label"><i class="fas fa-camera me-2"></i>Foto do Local (Opcional)</label>
                            <input type="file" class="form-control" id="flood-photo" accept="image/*">
                        </div>

                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-paper-plane me-2"></i>Enviar Relato
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Configura√ß√µes Iniciais
        let map, markers, userMarker, reportMarker;
        let currentTheme = localStorage.getItem('theme') || 'light';
        const API_KEY = '71907d1b560a5fae3ee6d175e1d9129b';

        // Inicializa√ß√£o do Mapa
        function initMap() {
            map = L.map('map').setView([-15.788, -47.879], 4);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            markers = L.markerClusterGroup();
            map.addLayer(markers);
            applyTheme(currentTheme);
            loadSavedReports();
            locateUser(true);
        }

        // Sistema de Temas
        function toggleTheme() {
            currentTheme = currentTheme === 'light' ? 'dark' : 'light';
            localStorage.setItem('theme', currentTheme);
            applyTheme(currentTheme);
        }

        function applyTheme(theme) {
            document.body.setAttribute('data-theme', theme);
            document.querySelector('.theme-switcher i').className = theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
        }

        // Geolocaliza√ß√£o
        function locateUser(initial = false) {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    const { latitude, longitude } = position.coords;
                    updateUserPosition(latitude, longitude);
                    getWeatherData(latitude, longitude);
                }, (error) => {
                    if(initial) showNotification('Ative a localiza√ß√£o para melhor precis√£o', 'warning');
                }, { enableHighAccuracy: true });
            }
        }

        function updateUserPosition(lat, lng) {
            if(userMarker) map.removeLayer(userMarker);
            userMarker = L.marker([lat, lng], {
                icon: L.divIcon({
                    className: 'user-marker',
                    html: '<i class="fas fa-map-marker-alt"></i>',
                    iconSize: [40, 40]
                })
            }).addTo(map);
            map.flyTo([lat, lng], 15);
        }

        // Sistema de Clima
        async function getWeatherData(lat, lon) {
            try {
                const response = await fetch(
                    `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${API_KEY}&units=metric&lang=pt_br`
                );
                const data = await response.json();
                
                document.getElementById('current-temp').textContent = `${Math.round(data.main.temp)}¬∞C`;
                document.getElementById('humidity').textContent = `${data.main.humidity}%`;
                document.getElementById('wind-speed').textContent = `${(data.wind.speed * 3.6).toFixed(1)}km/h`;
                document.getElementById('pressure').textContent = `${data.main.pressure}hPa`;
                document.getElementById('rain').textContent = data.rain ? `${(data.rain['1h'] || 0).toFixed(1)}mm` : '0.0mm';
                
                const weatherIcon = document.querySelector('.weather-icon');
                weatherIcon.className = `wi wi-owm-${data.weather[0].id} weather-icon`;
                getCityName(lat, lon);
                
            } catch (error) {
                showNotification('Erro ao carregar dados do clima', 'danger');
            }
        }

        async function getCityName(lat, lon) {
            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`
                );
                const data = await response.json();
                const city = data.address.city || data.address.town || data.address.village || data.address.county;
                document.getElementById('city-name').textContent = city;
            } catch (error) {
                console.error('Erro ao obter nome da cidade:', error);
            }
        }

        // Sistema de Relat√≥rios
        async function searchLocation() {
            const address = document.getElementById('address').value;
            if(!address) return showNotification('Digite um endere√ßo v√°lido', 'warning');
            
            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`
                );
                const data = await response.json();
                
                if(data.length > 0) {
                    const { lat, lon } = data[0];
                    updateReportMarker(lat, lon);
                    map.flyTo([lat, lon], 15);
                }
            } catch (error) {
                showNotification('Erro ao buscar localiza√ß√£o', 'danger');
            }
        }

        function updateReportMarker(lat, lng) {
            if(reportMarker) map.removeLayer(reportMarker);
            reportMarker = L.marker([lat, lng], {
                draggable: true,
                icon: L.divIcon({
                    className: 'report-marker',
                    html: '<i class="fas fa-map-pin"></i>',
                    iconSize: [40, 40]
                })
            }).addTo(map);
            
            reportMarker.on('dragend', async () => {
                const { lat, lng } = reportMarker.getLatLng();
                try {
                    const response = await fetch(
                        `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`
                    );
                    const data = await response.json();
                    document.getElementById('address').value = data.display_name || `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
                } catch (error) {
                    document.getElementById('address').value = `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
                }
            });
        }

        document.getElementById('reportForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if(!reportMarker) return showNotification('Selecione uma localiza√ß√£o no mapa', 'warning');
            
            const report = {
                type: currentReportType,
                location: reportMarker.getLatLng(),
                details: currentReportType === 'pedestre' ? {
                    waterLevel: document.getElementById('water-level').value
                } : {
                    vehicleModel: document.getElementById('vehicle-model').value,
                    submersionLevel: document.getElementById('car-water-level').value
                },
                photo: await readPhoto(),
                timestamp: new Date()
            };

            addReportToMap(report);
            saveReport(report);
            showNotification('Relato enviado com sucesso!', 'success');
            e.target.reset();
        });

        async function readPhoto() {
            const file = document.getElementById('flood-photo').files[0];
            if(!file) return null;
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.readAsDataURL(file);
            });
        }

        function addReportToMap(report) {
            const marker = L.marker([report.location.lat, report.location.lng], {
                icon: L.divIcon({
                    html: `<div style="background:${getColorByLevel(report)}" class="report-marker">
                            ${report.type === 'pedestre' ? 'üö∂' : 'üöó'}
                          </div>`
                })
            }).bindPopup(createPopupContent(report));
            markers.addLayer(marker);
        }

        function getColorByLevel(report) {
            const levels = {
                pedestre: { '0.2': '#10B981', '0.5': '#F59E0B', '1.0': '#EF4444', '1.5': '#DC2626', '2.0': '#7C3AED' },
                motorista: { '25': '#10B981', '50': '#F59E0B', '75': '#EF4444', '100': '#DC2626' }
            };
            return levels[report.type][report.details[report.type === 'pedestre' ? 'waterLevel' : 'submersionLevel']];
        }

        function createPopupContent(report) {
            return `
                <div style="min-width: 200px">
                    <h6>${report.type === 'pedestre' ? 'Relato de Pedestre' : 'Relato de Motorista'}</h6>
                    <small>${new Date(report.timestamp).toLocaleString()}</small>
                    ${report.photo ? `<img src="${report.photo}" class="img-fluid mt-2">` : ''}
                </div>
            `;
        }

        function saveReport(report) {
            const reports = JSON.parse(localStorage.getItem('floodReports') || '[]');
            reports.push(report);
            localStorage.setItem('floodReports', JSON.stringify(reports));
        }

        function loadSavedReports() {
            const reports = JSON.parse(localStorage.getItem('floodReports') || '[]');
            reports.forEach(addReportToMap);
        }

        function toggleReportType(type) {
            currentReportType = type;
            document.querySelectorAll('.btn-outline-primary').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            document.querySelectorAll('[id$="-form"]').forEach(el => el.classList.add('d-none'));
            document.getElementById(`${type}-form`).classList.remove('d-none');
        }

        function showNotification(message, type) {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} position-fixed top-0 end-0 m-3`;
            alert.textContent = message;
            document.body.appendChild(alert);
            setTimeout(() => alert.remove(), 3000);
        }

        // Inicializa√ß√£o
        initMap();
    </script>
</body>
</html>
