<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ClimaJá!</title>
  <link rel="icon" type="image/png" href="logo.png">

  <!-- CSS externos -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/weather-icons/2.0.12/css/weather-icons.min.css">
  <!-- Nosso CSS -->
  <link rel="stylesheet" href="styles.css">
  <style>
    .main-header {
      background: linear-gradient(90deg, #1e40af 0%, #2563eb 60%, #38bdf8 100%);
      color: #fff;
      box-shadow: 0 8px 32px -8px #2563eb44;
      padding: 2.2rem 1.2rem 1.5rem 1.2rem;
      margin-bottom: 2.5rem;
      display: flex;
      align-items: center;
      gap: 2rem;
      justify-content: center;
      flex-wrap: wrap;
      border-radius: 0;
      border: 2px solid #2563eb;
      position: relative;
      overflow: hidden;
    }
    .main-header .logo-box {
      background: none; /* Remove o fundo branco */
      border-radius: 1.5rem;
      box-shadow: 0 2px 12px #2563eb22;
      padding: 0.4rem 1.1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 170px; /* Aumenta ainda mais a altura */
      width: 200px;  /* Aumenta bastante a largura */
      transition: transform 0.3s;
    }
    .main-header img {
      height: 140px; /* Aumenta ainda mais a logo */
      width: 180px;  /* Deixa a logo mais larga */
      object-fit: contain;
      border-radius: 1rem;
      background: none;
      box-shadow: none;
      padding: 0;
      transition: transform 0.3s;
    }
    .main-header .project-title {
      font-size: 3.7rem; /* Título ainda maior */
      font-weight: 900;
      letter-spacing: 2.5px;
      margin-bottom: 0.4rem;
      color: #fff;
      text-shadow: 0 2px 12px #2563eb44;
    }
    .main-header .project-desc {
      font-size: 2rem; /* Subtítulo maior */
      font-weight: 600;
      opacity: 0.98;
      color: #e0e7ff;
    }
    /* Ajuste para o container do mapa */
    #map {
      min-height: 350px;
      height: 60vh;
      border-radius: 1rem;
      border: 1.5px solid var(--primary);
      background: var(--card-bg);
      box-shadow: 0 2px 12px #2563eb22;
      margin-bottom: 1rem;
    }
    /* Animações para login/cadastro */
    .fade-in {
      animation: fadeInLogin 0.5s;
    }
    .fade-out {
      animation: fadeOutLogin 0.4s forwards;
    }
    @keyframes fadeInLogin {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: none; }
    }
    @keyframes fadeOutLogin {
      from { opacity: 1; }
      to { opacity: 0; transform: translateY(-20px); }
    }
    .form-control:invalid {
      border-color: #dc2626;
      box-shadow: 0 0 0 2px #dc262622;
    }
    .form-control:valid {
      border-color: #22c55e;
      box-shadow: 0 0 0 2px #22c55e22;
    }
    .form-feedback {
      font-size: 0.95rem;
      color: #dc2626;
      margin-top: -0.7rem;
      margin-bottom: 0.7rem;
      display: none;
    }
    .form-feedback.active {
      display: block;
    }
    /* Animação para o quadro Sobre o Projeto e Clima */
    .main-card.sobre-anim, .main-card.clima-anim {
      animation: sobreFadeIn 1.1s cubic-bezier(.23,1.02,.32,1) both;
      box-shadow: 0 8px 32px -8px #2563eb33, 0 1.5px 12px #38bdf822;
      border: 2px solid #38bdf8;
      background: linear-gradient(120deg, #f0f9ff 60%, #e0f2fe 100%);
      transition: box-shadow 0.4s, border 0.4s, background 0.4s, transform 0.35s cubic-bezier(.23,1.02,.32,1);
    }
    .tab-pane#clima .main-card.clima-anim {
      cursor: pointer;
      transition: box-shadow 0.4s, border 0.4s, background 0.4s, transform 0.35s cubic-bezier(.23,1.02,.32,1);
    }
    .tab-pane#clima .main-card.clima-anim:hover {
      transform: scale(1.045) translateY(-8px);
      box-shadow: 0 20px 56px -8px #2563eb55, 0 8px 32px #38bdf855;
      border-color: #2563eb;
      background: linear-gradient(120deg, #e0f2fe 60%, #bae6fd 100%);
    }
    @keyframes sobreFadeIn {
      0% {
        opacity: 0;
        transform: scale(0.97) translateY(40px) skewY(2deg);
        filter: blur(6px);
      }
      60% {
        opacity: 1;
        filter: blur(0.5px);
      }
      100% {
        opacity: 1;
        transform: scale(1) translateY(0) skewY(0);
        filter: blur(0);
      }
    }
    @media (max-width: 600px) {
      .main-header {
        flex-direction: column;
        gap: 0.7rem;
        padding: 1.1rem 0.3rem 1.1rem 0.3rem;
      }
      .main-header .logo-box {
        height: 80px;
        width: 110px;
        padding: 0.2rem 0.7rem;
        border-radius: 1.1rem;
      }
      .main-header img {
        height: 60px;
        width: 90px;
        border-radius: 0.7rem;
      }
      .main-header .project-title {
        font-size: 1.7rem;
      }
      .main-header .project-desc {
        font-size: 1.15rem;
      }
      .container.my-4 {
        padding-left: 0.2rem;
        padding-right: 0.2rem;
      }
    }
    [data-theme="dark"] .main-card.sobre-anim, [data-theme="dark"] .main-card.clima-anim {
      background: linear-gradient(120deg, #1e293b 60%, #0f172a 100%) !important;
      color: #f8fafc !important;
      border-color: #60a5fa;
    }
    [data-theme="dark"] .main-card.sobre-anim h2,
    [data-theme="dark"] .main-card.sobre-anim p,
    [data-theme="dark"] .main-card.clima-anim h2,
    [data-theme="dark"] .main-card.clima-anim p,
    [data-theme="dark"] .main-card.clima-anim .weather-header,
    [data-theme="dark"] .main-card.clima-anim .weather-item,
    [data-theme="dark"] .main-card.clima-anim .sensor-value {
      color: #f8fafc !important;
      text-shadow: 0 2px 8px #0f172a99;
    }
    [data-theme="dark"] .main-card.clima-anim .weather-item {
      background: #1e293bcc !important;
      border-color: #334155 !important;
    }
    [data-theme="dark"] .main-card.clima-anim .weather-icon {
      color: #60a5fa !important;
      filter: drop-shadow(0 2px 8px #60a5fa33);
    }
  </style>
</head>
<body>
  <div class="theme-switcher" onclick="toggleTheme()">
    <i class="fas fa-moon"></i>
  </div>

  <header class="main-header">
    <div class="logo-box">
      <img src="logo.png" alt="Logo ClimaJá!">
    </div>
    <div>
      <div class="project-title">ClimaJá!</div>
      <div class="project-desc">Monitoramento Meteorológico e Relatos de Alagamentos em Tempo Real</div>
    </div>
    <div class="d-flex justify-content-end align-items-center pe-3" style="position:absolute;top:1.5rem;right:0;z-index:10;">
      <a class="btn btn-outline-light btn-sm fw-bold" id="entrar-btn" href="#">
        <i class="fas fa-sign-in-alt me-1"></i>Entrar
      </a>
      <div id="perfil-header" class="d-none ms-2"></div>
    </div>
  </header>

  <div class="container my-4">
    <ul class="nav nav-pills justify-content-center mb-4">
      <li class="nav-item">
        <a class="nav-link active" data-bs-toggle="pill" href="#projeto">
          <i class="fas fa-info-circle me-2"></i>Sobre o Projeto
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" data-bs-toggle="pill" href="#mapa">
          <i class="fas fa-map me-2"></i>Mapa
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" data-bs-toggle="pill" href="#clima">
          <i class="fas fa-sun me-2"></i>Clima
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" data-bs-toggle="pill" href="#relatar">
          <i class="fas fa-edit me-2"></i>Relatar
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" data-bs-toggle="pill" href="#sobre">
          <i class="fas fa-user me-2"></i>Sobre Nós
        </a>
      </li>
      <li class="nav-item d-none" id="nav-login-item">
      </li>
    </ul>

    <div class="tab-content">
      <!-- === Aba Projeto (principal) === -->
      <div class="tab-pane fade show active" id="projeto">
        <div class="main-card text-center sobre-anim">
          <h2 class="mb-3"><i class="fas fa-info-circle me-2"></i>Sobre o Projeto</h2>
          <p class="mb-3">O <strong>ClimaJá!</strong> é uma plataforma colaborativa para monitoramento meteorológico e relatos de alagamentos em tempo real. O objetivo é ajudar pessoas a se informarem sobre as condições do clima e compartilharem informações úteis para a sociedade, promovendo segurança e prevenção.</p>
          <p class="mb-3">Aqui você pode visualizar o mapa de alagamentos, consultar dados climáticos atualizados e relatar ocorrências de forma simples e rápida, contribuindo para uma cidade mais resiliente.</p>
        </div>
      </div>
      <!-- === Aba Sobre Nós === -->
      <div class="tab-pane fade" id="sobre">
        <div class="main-card text-center">
          <h2 class="mb-3"><i class="fas fa-user me-2"></i>Sobre Nós</h2>
          <img src="logo.png" alt="Avatar" style="width:80px;height:80px;border-radius:50%;box-shadow:0 2px 8px #2563eb22;margin-bottom:1rem;">
          <p class="mb-1">Olá! Nós somos da <strong>Escola Técnica Estadual Ginásio Pernambucano</strong>, uma equipe apaixonada por tecnologia, meteorologia e soluções inovadoras para a sociedade. O ClimaJá! foi criado para ajudar pessoas a monitorar o clima e compartilhar informações importantes sobre alagamentos em tempo real.</p>
          <div class="mb-2">
            <a href="mailto:oclimaja@hotmail.com" class="btn btn-modern btn-sm me-2"><i class="fas fa-envelope"></i> Email</a>
            <a href="#" class="btn btn-modern btn-sm"><i class="fab fa-linkedin"></i> LinkedIn</a>
          </div>
          <p class="text-muted small">Entre em contato: <a href="mailto:oclimaja@hotmail.com">oclimaja@hotmail.com</a></p>
        </div>
      </div>
      <!-- === Aba Mapa === -->
      <div class="tab-pane fade" id="mapa">
        <div class="main-card">
          <div id="map"></div>
          <div class="mt-3 text-center">
            <button class="btn btn-modern" onclick="locateUser(true)">
              <i class="fas fa-location-crosshairs me-2"></i>Minha Localização
            </button>
          </div>
        </div>
      </div>
      <!-- === Aba Clima === -->
      <div class="tab-pane fade" id="clima">
        <div class="main-card clima-anim">
          <div class="weather-header">
            <i class="wi wi-day-sunny weather-icon"></i>
            <div>
              <h2 class="mb-0" id="city-name">Carregando...</h2>
              <div class="sensor-value" id="current-temp">--°C</div>
            </div>
          </div>
          <div class="weather-grid">
            <div class="weather-item">
              <i class="wi wi-humidity"></i>
              <div class="mt-2">
                <div class="text-muted small">Umidade</div>
                <div class="fw-bold" id="humidity">--%</div>
              </div>
            </div>
            <div class="weather-item">
              <i class="wi wi-rain"></i>
              <div class="mt-2">
                <div class="text-muted small">Chuva</div>
                <div class="fw-bold" id="rain">--mm</div>
              </div>
            </div>
            <div class="weather-item">
              <i class="wi wi-strong-wind"></i>
              <div class="mt-2">
                <div class="text-muted small">Vento</div>
                <div class="fw-bold" id="wind-speed">--km/h</div>
              </div>
            </div>
            <div class="weather-item">
              <i class="wi wi-barometer"></i>
              <div class="mt-2">
                <div class="text-muted small">Pressão</div>
                <div class="fw-bold" id="pressure">--hPa</div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- === Aba Relatar === -->
      <div class="tab-pane fade" id="relatar">
        <div class="main-card" id="relato-area">
          <!-- O conteúdo do formulário será controlado via JS -->
        </div>
      </div>
      <!-- === Aba Login/Cadastro === -->
      <div class="tab-pane fade" id="login">
        <div class="main-card text-center mx-auto fade-in" style="max-width:400px;">
          <h4 class="mb-3"><i class="fas fa-user-circle me-2"></i>Entrar</h4>
          <form id="loginForm" autocomplete="off">
            <div class="mb-3">
              <input type="text" class="form-control" id="login-username" placeholder="Usuário" required minlength="3">
              <div class="form-feedback" id="login-user-feedback"></div>
            </div>
            <div class="mb-3">
              <input type="password" class="form-control" id="login-password" placeholder="Senha" required minlength="4">
              <div class="form-feedback" id="login-pass-feedback"></div>
            </div>
            <button type="submit" class="btn btn-modern w-100 mb-2" id="loginBtn">Entrar</button>
            <button type="button" class="btn btn-outline-primary w-100" id="showRegister">Cadastrar</button>
          </form>
          <form id="registerForm" class="d-none" autocomplete="off">
            <div class="mb-3">
              <input type="text" class="form-control" id="register-username" placeholder="Usuário" required minlength="3">
              <div class="form-feedback" id="register-user-feedback"></div>
            </div>
            <div class="mb-3">
              <input type="password" class="form-control" id="register-password" placeholder="Senha" required minlength="4">
              <div class="form-feedback" id="register-pass-feedback"></div>
            </div>
            <button type="submit" class="btn btn-modern w-100 mb-2" id="registerBtn">Cadastrar</button>
            <button type="button" class="btn btn-outline-secondary w-100" id="showLogin">Já tenho conta</button>
          </form>
          <div id="login-success" class="alert alert-success d-none mt-3"></div>
        </div>
      </div>
      <!-- === Aba Perfil === -->
      <div class="tab-pane fade" id="perfil">
        <div class="main-card text-center" id="perfil-area">
          <!-- Conteúdo do perfil será preenchido via JS -->
        </div>
      </div>
    </div>
  </div>

  <footer class="bg-light py-4 mt-5 border-top" style="transition:background 0.3s;">
    <div class="container text-center">
      <h5 class="mb-2"><i class="fas fa-cloud-sun me-2"></i>ClimaJá! &copy; 2025</h5>
      <p class="mb-1">Projeto de monitoramento meteorológico e relatos de alagamentos. Desenvolvido por Escola Técnica Estadual Ginásio Pernambucano.</p>
      <div class="mb-2">
        <a href="#" class="me-2 text-primary"><i class="fab fa-github fa-lg"></i></a>
        <a href="#" class="me-2 text-primary"><i class="fab fa-linkedin fa-lg"></i></a>
        <a href="#" class="text-primary"><i class="fab fa-twitter fa-lg"></i></a>
      </div>
      <p class="text-muted small">Entre em contato: <a href="mailto:oclimaja@hotmail.com">oclimaja@hotmail.com</a></p>
    </div>
  </footer>

  <!-- JS externos -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Nosso JS -->
  <script src="script.js"></script>
  <script>
    // Inicializa o mapa apenas uma vez, na primeira vez que a aba "Mapa" for exibida
    let mapaJaIniciado = false;
    document.querySelectorAll('a[data-bs-toggle="pill"]').forEach(function(tab) {
      tab.addEventListener('shown.bs.tab', function (e) {
        if (e.target.getAttribute('href') === '#mapa' && !mapaJaIniciado) {
          setTimeout(function() {
            if (typeof initMap === 'function') {
              initMap();
              mapaJaIniciado = true;
            }
          }, 200);
        }
      });
    });
    // Adiciona CSS para garantir que o mapa sempre receba eventos
    const style = document.createElement('style');
    style.innerHTML = `#map { pointer-events: auto !important; }`;
    document.head.appendChild(style);

    // Login/Cadastro LocalStorage
    function getUsers() {
      return JSON.parse(localStorage.getItem('users')||'{}');
    }
    function saveUser(username, password) {
      const users = getUsers();
      users[username] = password;
      localStorage.setItem('users', JSON.stringify(users));
    }
    // Alternância entre login/cadastro
    document.getElementById('showRegister').onclick = function() {
      const loginForm = document.getElementById('loginForm');
      const registerForm = document.getElementById('registerForm');
      loginForm.classList.add('fade-out');
      setTimeout(() => {
        loginForm.classList.add('d-none');
        loginForm.classList.remove('fade-out');
        registerForm.classList.remove('d-none');
        registerForm.classList.add('fade-in');
      }, 350);
    };
    document.getElementById('showLogin').onclick = function() {
      const loginForm = document.getElementById('loginForm');
      const registerForm = document.getElementById('registerForm');
      registerForm.classList.add('fade-out');
      setTimeout(() => {
        registerForm.classList.add('d-none');
        registerForm.classList.remove('fade-out');
        loginForm.classList.remove('d-none');
        loginForm.classList.add('fade-in');
      }, 350);
    };

    // Validação visual e loading no login
    document.getElementById('loginForm').onsubmit = function(e) {
      e.preventDefault();
      const u = document.getElementById('login-username').value.trim();
      const p = document.getElementById('login-password').value;
      const userFeedback = document.getElementById('login-user-feedback');
      const passFeedback = document.getElementById('login-pass-feedback');
      userFeedback.classList.remove('active');
      passFeedback.classList.remove('active');
      let valid = true;
      if (!u || u.length < 3) {
        userFeedback.textContent = 'Usuário deve ter pelo menos 3 caracteres.';
        userFeedback.classList.add('active');
        valid = false;
      }
      if (!p || p.length < 4) {
        passFeedback.textContent = 'Senha deve ter pelo menos 4 caracteres.';
        passFeedback.classList.add('active');
        valid = false;
      }
      if (!valid) return;
      const users = getUsers();
      const btn = document.getElementById('loginBtn');
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Entrando...';
      setTimeout(() => {
        if (users[u] && users[u] === p) {
          localStorage.setItem('user', u);
          showRelatoArea();
          document.getElementById('loginForm').reset();
          document.getElementById('login-success').textContent = 'Login realizado com sucesso!';
          document.getElementById('login-success').classList.remove('d-none');
          atualizarInterfaceUsuario();
          atualizarHeaderUsuario();
          criarAbaPerfil();
          setTimeout(() => {
            document.getElementById('login-success').classList.add('d-none');
            document.getElementById('loginForm').classList.add('d-none');
            // Ativa aba perfil
            const perfilTabLink = document.querySelector('a[data-bs-toggle="pill"][href="#perfil"]');
            if (perfilTabLink) perfilTabLink.click();
            // Ou ativa diretamente
            const perfilPane = document.getElementById('perfil');
            document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('show', 'active'));
            if (perfilPane) {
              perfilPane.classList.add('show', 'active');
              renderizarPerfil();
            }
          }, 1200);
        } else {
          passFeedback.textContent = 'Usuário ou senha inválidos!';
          passFeedback.classList.add('active');
        }
        btn.disabled = false;
        btn.innerHTML = 'Entrar';
      }, 800);
    };

    // Validação visual e loading no cadastro
    document.getElementById('registerForm').onsubmit = function(e) {
      e.preventDefault();
      const u = document.getElementById('register-username').value.trim();
      const p = document.getElementById('register-password').value;
      const userFeedback = document.getElementById('register-user-feedback');
      const passFeedback = document.getElementById('register-pass-feedback');
      userFeedback.classList.remove('active');
      passFeedback.classList.remove('active');
      let valid = true;
      if (!u || u.length < 3) {
        userFeedback.textContent = 'Usuário deve ter pelo menos 3 caracteres.';
        userFeedback.classList.add('active');
        valid = false;
      }
      if (!p || p.length < 4) {
        passFeedback.textContent = 'Senha deve ter pelo menos 4 caracteres.';
        passFeedback.classList.add('active');
        valid = false;
      }
      const users = getUsers();
      if (users[u]) {
        userFeedback.textContent = 'Usuário já existe!';
        userFeedback.classList.add('active');
        valid = false;
      }
      if (!valid) return;
      const btn = document.getElementById('registerBtn');
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Cadastrando...';
      setTimeout(() => {
        saveUser(u, p);
        document.getElementById('registerForm').reset();
        document.getElementById('login-success').textContent = 'Cadastro realizado! Faça login.';
        document.getElementById('login-success').classList.remove('d-none');
        setTimeout(() => {
          document.getElementById('login-success').classList.add('d-none');
          document.getElementById('registerForm').classList.add('d-none');
          document.getElementById('loginForm').classList.remove('d-none');
        }, 1200);
        btn.disabled = false;
        btn.innerHTML = 'Cadastrar';
      }, 900);
    };

    // Exibir aba de login/cadastro ao clicar em "Entrar" no topo
    const entrarBtn = document.getElementById('entrar-btn');
    if (entrarBtn) {
      entrarBtn.addEventListener('click', function(e) {
        e.preventDefault();
        // Ativa a aba de login
        const loginTab = document.querySelector('a[data-bs-toggle="pill"][href="#login"]');
        if (loginTab) {
          loginTab.click();
        } else {
          // Se não houver aba, ativa manualmente
          document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('show', 'active'));
          const loginPane = document.getElementById('login');
          if (loginPane) {
            loginPane.classList.add('show', 'active');
            loginPane.scrollIntoView({behavior:'smooth'});
          }
        }
      });
    }

    // Garante que a área de relato seja exibida ao acessar a aba Relatar
    const relatarTab = document.querySelector('a[data-bs-toggle="pill"][href="#relatar"]');
    if (relatarTab) {
      relatarTab.addEventListener('shown.bs.tab', function() {
        if (typeof showRelatoArea === 'function') showRelatoArea();
      });
    }

    // Interligar usuário ao relato enviado
    function saveRelato(relato) {
      const relatos = JSON.parse(localStorage.getItem('relatos')||'[]');
      relatos.push(relato);
      localStorage.setItem('relatos', JSON.stringify(relatos));
    }
    // Adicionar usuário logado ao relato
    document.addEventListener('submit', function(e) {
      if (e.target && e.target.id === 'reportForm') {
        e.preventDefault();
        const user = localStorage.getItem('user');
        if (!user) return alert('Você precisa estar logado para enviar um relato!');
        // Exemplo de coleta dos dados do relato (adicione mais campos conforme necessário)
        const tipo = document.querySelector('.btn-outline-primary.active').textContent.trim();
        const nivelAgua = document.getElementById('water-level') ? document.getElementById('water-level').value : '';
        const modeloVeiculo = document.getElementById('vehicle-model') ? document.getElementById('vehicle-model').value : '';
        const nivelCarro = document.getElementById('car-water-level') ? document.getElementById('car-water-level').value : '';
        const endereco = document.getElementById('address') ? document.getElementById('address').value : '';
        // Foto não será salva no localStorage (apenas nome)
        const relato = {
          usuario: user,
          tipo,
          nivelAgua,
          modeloVeiculo,
          nivelCarro,
          endereco,
          data: new Date().toISOString()
        };
        saveRelato(relato);
        alert('Relato enviado com sucesso! Obrigado por contribuir, ' + user + '.');
        e.target.reset();
      }
    });

    // Garante que a função showRelatoArea está definida
    function showRelatoArea() {
      const area = document.getElementById('relato-area');
      if (!area) return;
      area.innerHTML = `
        <form id="reportForm">
          <div class="mb-3">
            <label for="address" class="form-label">Endereço</label>
            <input type="text" class="form-control" id="address" placeholder="Digite o endereço ou selecione no mapa" required>
          </div>
          <div class="mb-3">
            <label for="water-level" class="form-label">Nível da Água</label>
            <select class="form-select" id="water-level" required>
              <option value="">Selecione</option>
              <option value="0.2">Até o tornozelo</option>
              <option value="0.5">Até o joelho</option>
              <option value="1.0">Até a cintura</option>
              <option value="1.5">Acima da cintura</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="flood-photo" class="form-label">Foto (opcional)</label>
            <input type="file" class="form-control" id="flood-photo" accept="image/*">
          </div>
          <button type="submit" class="btn btn-modern">Enviar Relato</button>
        </form>
      `;
    }

    // Função para atualizar interface após login/logout
    function atualizarInterfaceUsuario() {
      const user = localStorage.getItem('user');
      const navLoginItem = document.getElementById('nav-login-item');
      if (user) {
        // Esconde aba de login
        if (navLoginItem) navLoginItem.classList.add('d-none');
      } else {
        // Mostra aba de login
        if (navLoginItem) navLoginItem.classList.remove('d-none');
      }
    }

    // Atualiza interface do header após login/logout
    function atualizarHeaderUsuario() {
      const user = localStorage.getItem('user');
      const entrarBtn = document.getElementById('entrar-btn');
      const perfilHeader = document.getElementById('perfil-header');
      if (user) {
        if (entrarBtn) entrarBtn.classList.add('d-none');
        if (perfilHeader) {
          perfilHeader.classList.remove('d-none');
          perfilHeader.innerHTML = `<button class="btn btn-outline-light btn-sm fw-bold d-flex align-items-center" id="perfil-header-btn"><i class="fas fa-user-circle me-1"></i><span class="d-none d-md-inline">${user}</span></button>`;
          document.getElementById('perfil-header-btn').onclick = function() {
            // Ativa a aba de perfil
            const perfilPane = document.getElementById('perfil');
            document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('show', 'active'));
            if (perfilPane) {
              perfilPane.classList.add('show', 'active');
              renderizarPerfil();
            }
            // Garante que o botão Entrar nunca aparece ao acessar o perfil
            if (entrarBtn) entrarBtn.classList.add('d-none');
          };
        }
      } else {
        if (entrarBtn) entrarBtn.classList.remove('d-none');
        if (perfilHeader) perfilHeader.classList.add('d-none');
      }
    }

    // Cria a aba de perfil na tab-content se não existir
    function criarAbaPerfil() {
      if (!document.getElementById('perfil')) {
        const tabContent = document.querySelector('.tab-content');
        const perfilPane = document.createElement('div');
        perfilPane.className = 'tab-pane fade';
        perfilPane.id = 'perfil';
        perfilPane.innerHTML = `
          <div class="main-card text-center" id="perfil-area">
            <!-- Conteúdo do perfil será preenchido via JS -->
          </div>
        `;
        tabContent.appendChild(perfilPane);
      }
    }

    // Interface moderna para o perfil
    function renderizarPerfil() {
      const user = localStorage.getItem('user');
      if (!user) return;
      criarAbaPerfil();
      const perfilArea = document.getElementById('perfil-area');
      const relatos = JSON.parse(localStorage.getItem('relatos')||'[]').filter(r => r.usuario === user);
      let html = `<div class='mb-4'>
        <img src='logo.png' alt='Avatar' style='width:90px;height:90px;border-radius:50%;box-shadow:0 2px 8px #2563eb22;margin-bottom:1rem;'>
        <h2 class="mb-1"><i class="fas fa-user"></i> <span class="text-primary">${user}</span></h2>
        <div class='text-muted mb-3'>Perfil do usuário</div>
        <button class="btn btn-outline-danger btn-sm mb-3" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Sair</button>
      </div>`;
      if (relatos.length === 0) {
        html += '<p class="text-muted">Você ainda não enviou nenhum relato.</p>';
      } else {
        html += '<h5 class="mb-2">Seus relatos:</h5>';
        html += '<ul class="list-group mb-3">';
        relatos.forEach((r, i) => {
          html += `<li class="list-group-item d-flex justify-content-between align-items-center">
            <span><b>${r.endereco}</b> <small class="text-muted">(${new Date(r.data).toLocaleString()})</small></span>
            <button class="btn btn-danger btn-sm" onclick="excluirRelato(${i})"><i class="fas fa-trash"></i></button>
          </li>`;
        });
        html += '</ul>';
      }
      perfilArea.innerHTML = html;
      // Garante que o botão Entrar nunca aparece ao renderizar o perfil
      const entrarBtn = document.getElementById('entrar-btn');
      if (entrarBtn) entrarBtn.classList.add('d-none');
      document.getElementById('logoutBtn').onclick = function() {
        localStorage.removeItem('user');
        atualizarInterfaceUsuario();
        atualizarHeaderUsuario();
        // Volta para aba principal
        document.querySelector('a[data-bs-toggle="pill"][href="#projeto"]').click();
      };
    }

    // Função global para excluir relato
    window.excluirRelato = function(idx) {
      const user = localStorage.getItem('user');
      let relatos = JSON.parse(localStorage.getItem('relatos')||'[]');
      // Só remove relatos do usuário logado
      const meusRelatos = relatos.filter(r => r.usuario === user);
      const relatoRemover = meusRelatos[idx];
      relatos = relatos.filter(r => r !== relatoRemover);
      localStorage.setItem('relatos', JSON.stringify(relatos));
      renderizarPerfil();
    };

    // Atualiza interface ao carregar
    atualizarInterfaceUsuario();
    atualizarHeaderUsuario();
    criarAbaPerfil();
  </script>
</body>
</html>
